<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TPBL App</title>
    
    <link rel="icon" type="image/png" href="https://i.postimg.cc/tC7n88C1/favicon.png">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/tC7n88C1/favicon.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0F2848">
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --tpbl-blue: #0F2848;
            --tpbl-gold: #D4B07D;
            --bg-color: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-main: #1C1C1E;
            --text-sub: #8E8E93;
            --live-red: #FF3B30;
            --trend-up: #FF3B30; /* 紅漲 */
            --trend-down: #34C759; /* 綠跌 */
            --bar-gray: #E5E5EA;
            --card-radius: 16px;
            --btn-radius: 8px;
            --page-padding: 24px;
            --header-height: 56px;
        }

        html { background-color: var(--tpbl-blue); }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang TC", "Microsoft JhengHei", "Heiti TC", "SF Pro Text", "Helvetica Neue", sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0;
            color: var(--text-main);
            padding-bottom: 100px;
            padding-top: calc(var(--header-height) + env(safe-area-inset-top) + 10px);
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            overflow-x: hidden;
        }
        
        body.modal-open { overflow: hidden; position: fixed; width: 100%; }
        .nums { font-variant-numeric: tabular-nums; letter-spacing: -0.5px; }

        /* --- Splash Screen --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--tpbl-blue); z-index: 99999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease-out, visibility 0.5s;
        }
        #splash-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .splash-logo { font-style: italic; font-weight: 900; font-size: 48px; color: #fff; letter-spacing: -1px; display: flex; align-items: center; gap: 8px; animation: breathe 2s infinite ease-in-out; }
        .splash-star { width: 12px; height: 12px; background: var(--tpbl-gold); clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); }
        .splash-spinner { margin-top: 30px; width: 30px; height: 30px; border: 3px solid rgba(255, 255, 255, 0.2); border-radius: 50%; border-top-color: var(--tpbl-gold); animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.9; } }

        /* --- Header --- */
        header.main-header {
            background: var(--tpbl-blue); color: #fff; height: var(--header-height);
            padding: 0 var(--page-padding); padding-top: env(safe-area-inset-top);
            position: fixed; top: 0; left: 0; right: 0; z-index: 100;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .header-left { position: absolute; left: var(--page-padding); }
        .brand-logo-center { font-style: italic; font-weight: 800; font-size: 24px; letter-spacing: -0.5px; display: flex; align-items: center; gap: 6px; position: absolute; left: 50%; transform: translateX(-50%); }
        .header-right { position: absolute; right: var(--page-padding); display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 500; }
        .brand-star { width: 10px; height: 10px; background: var(--tpbl-gold); clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); }
        .season-badge { font-size: 11px; font-weight: 600; color: var(--tpbl-blue); background: var(--tpbl-gold); padding: 3px 8px; border-radius: 6px; }
        .live-indicator { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; display: inline-block; opacity: 0; transition: opacity 0.3s;}
        .live-indicator.active { opacity: 1; animation: pulse-green 1.5s infinite; }
        @keyframes pulse-green { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* --- Sub-Page --- */
        .sub-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 2000;
            transform: translateX(100%); transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
            display: flex; flex-direction: column; box-shadow: -10px 0 20px rgba(0,0,0,0.1);
        }
        .sub-page.active { transform: translateX(0); }
        .nav-bar {
            background: var(--tpbl-blue); height: var(--header-height);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 8px; padding-top: env(safe-area-inset-top);
            flex-shrink: 0; position: relative; z-index: 10; color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .nav-left, .nav-right { width: 60px; display: flex; align-items: center; height: 100%; }
        .nav-back-btn { background: none; border: none; display: flex; align-items: center; gap: 4px; color: #fff; font-size: 16px; font-weight: 500; cursor: pointer; padding: 0 8px; height: 100%; }
        .nav-title { flex: 1; text-align: center; font-size: 17px; font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sub-page-body { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 20px var(--page-padding) 40px var(--page-padding); }

        /* --- Components --- */
        .container { padding: var(--page-padding); max-width: 600px; margin: 0 auto; min-height: 80vh; }
        .section-header { display: flex; align-items: center; justify-content: space-between; margin: 24px 0 12px 0; color: var(--tpbl-blue); }
        .section-title { font-size: 18px; font-weight: 800; display: flex; align-items: center; letter-spacing: -0.5px; }
        .section-date { font-size: 13px; color: var(--text-sub); font-weight: 500; }
        .section-divider { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 700; color: var(--text-sub); margin: 24px 0 12px 0; text-transform: uppercase; letter-spacing: 0.5px; }

        .smart-board-wrapper { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; gap: 16px; padding: 4px var(--page-padding) 20px var(--page-padding); margin: 0 calc(var(--page-padding) * -1); scrollbar-width: none; }
        .smart-board-wrapper::-webkit-scrollbar { display: none; }
        .match-card { background: var(--card-bg); border-radius: var(--card-radius); box-shadow: 0 6px 16px rgba(0,0,0,0.06); overflow: hidden; display: flex; flex-direction: column; min-width: calc(100vw - (var(--page-padding) * 2)); max-width: 500px; scroll-snap-align: center; position: relative; }
        .match-status-bar { background: #FAFAFA; padding: 10px 16px; font-size: 11px; font-weight: 600; color: var(--text-sub); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; }
        .venue-info { display: flex; align-items: center; gap: 4px; cursor: pointer; transition: opacity 0.2s; }
        .venue-info:active { opacity: 0.6; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; letter-spacing: 0.5px; }
        .badge.live { background: var(--live-red); color: white; display: flex; align-items: center; gap: 4px; animation: pulse 2s infinite; }
        .badge.final { background: #E5E5EA; color: #636366; }
        .badge.date { background: rgba(15, 40, 72, 0.08); color: var(--tpbl-blue); }
        .match-content { padding: 16px 12px; display: flex; align-items: center; justify-content: space-between; }
        .team-col { display: flex; flex-direction: column; align-items: center; flex: 1; gap: 6px; min-width: 0; }
        .team-logo-lg { width: 60px; height: 60px; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.05)); }
        .team-name { font-size: 14px; font-weight: 700; color: var(--text-main); text-align: center; white-space: nowrap; width: 100%; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
        .team-col.loser .team-name { color: var(--text-sub); }
        .team-col.loser .team-logo-lg { opacity: 0.6; filter: grayscale(0.8); }
        .score-col { text-align: center; min-width: 80px; display: flex; flex-direction: column; align-items: center; gap: 2px;}
        .score-val { font-size: 36px; font-weight: 800; color: var(--tpbl-blue); line-height: 1; font-family: 'SF Mono', monospace; letter-spacing: -2px; transition: color 0.2s; }
        .score-val.updated { color: var(--live-red); animation: score-pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .live-timer { font-size: 11px; color: var(--live-red); font-weight: 700; font-family: 'SF Mono', monospace; background: rgba(255, 59, 48, 0.1); padding: 2px 6px; border-radius: 8px; margin-bottom: 2px;}
        .score-vs { font-size: 20px; font-weight: 800; color: var(--tpbl-gold); margin-bottom: 0; font-style: italic; }
        .game-time-big { font-size: 20px; font-weight: 700; color: var(--tpbl-blue); font-family: 'SF Mono', monospace; }
        .match-actions { padding: 0 16px 16px 16px; margin-top: 0; z-index: 10; position: relative;}
        .action-btn { display: flex; align-items: center; justify-content: center; gap: 6px; width: 100%; padding: 12px 0; border-radius: 12px; font-size: 13px; font-weight: 600; text-decoration: none; transition: all 0.2s; cursor: pointer; }
        .btn-live { background: var(--live-red); color: white; box-shadow: 0 4px 10px rgba(255, 59, 48, 0.3); }
        .btn-highlight { background: #F2F2F7; color: var(--text-sub); }
        .btn-ticket { background: var(--tpbl-blue); color: white; }
        .action-btn:active { transform: scale(0.97); }
        .carousel-dots { display: flex; justify-content: center; gap: 6px; margin-top: -8px; margin-bottom: 24px; }
        .dot { width: 5px; height: 5px; background: #D1D1D6; border-radius: 50%; transition: all 0.3s ease; }
        .dot.active { background: var(--tpbl-blue); width: 12px; border-radius: 10px; }

        /* MVP Section */
        .mvp-section { margin: 10px 0; display: flex; gap: 10px; overflow-x: auto; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; padding-bottom: 6px; }
        .mvp-card { background: linear-gradient(135deg, #1a1a1a, #2c2c2e); border-radius: 14px; padding: 16px; color: #fff; flex: 0 0 100%; scroll-snap-align: center; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .mvp-card::before { content:''; position: absolute; top:-50%; left:-50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(212,176,125,0.15) 0%, rgba(0,0,0,0) 70%); pointer-events: none;}
        .mvp-info { z-index: 2; flex: 1; }
        .mvp-label { color: var(--tpbl-gold); font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .mvp-month { font-size: 16px; font-weight: 800; margin-bottom: 8px; line-height: 1.2; }
        .mvp-players-row { display: flex; gap: 12px; margin-top: 6px; }
        .mvp-p-item { display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.1); padding: 4px 10px 4px 4px; border-radius: 30px; backdrop-filter: blur(5px); }
        .mvp-p-img { width: 32px; height: 32px; border-radius: 50%; background: #fff; object-fit: cover; border: 2px solid var(--tpbl-gold); object-position: top center; }
        .mvp-p-text { display: flex; flex-direction: column; }
        .mvp-p-name { font-size: 11px; font-weight: 700; }
        .mvp-p-team { font-size: 9px; opacity: 0.8; }

        .st-card { background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.02); }
        .st-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .st-table th { background: #FAFAFA; color: var(--text-sub); font-weight: 600; padding: 10px 8px; text-align: center; font-size: 11px; }
        .st-table td { padding: 12px 6px; border-bottom: 1px solid #eee; text-align: center; font-weight: 500; }
        .st-team { text-align: left; display: flex; align-items: center; gap: 8px; font-weight: 600; color: var(--text-main); }
        .win-pct { color: var(--tpbl-blue); font-weight: 700; background: rgba(15, 40, 72, 0.05); padding: 2px 5px; border-radius: 4px; }

        /* Schedule */
        .sch-container { display: flex; flex-direction: column; gap: 12px; padding-bottom: 16px; }
        .sch-card { background: #fff; border-radius: 12px; padding: 0; display: flex; flex-direction: column; gap: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: none; position: relative; overflow: hidden; transition: transform 0.1s; }
        .sch-card:active { transform: scale(0.98); }
        .sch-card-main { padding: 12px 16px; display: flex; align-items: center; gap: 12px; }
        .sch-date-col { display: flex; flex-direction: column; align-items: center; justify-content: center; border-right: 1px solid #f0f0f0; padding-right: 12px; min-height: 40px; min-width: 45px;}
        .sch-date-main { font-size: 17px; font-weight: 800; color: var(--tpbl-blue); line-height: 1; margin-bottom: 2px; }
        .sch-date-sub { font-size: 10px; font-weight: 700; color: #C7C7CC; text-transform: uppercase; }
        .sch-time { font-size: 11px; font-weight: 600; color: var(--text-main); margin-top: 4px; font-family: 'SF Mono', monospace; }
        .sch-matchup { display: flex; flex-direction: column; gap: 8px; justify-content: center; flex: 1; }
        .sch-team-row { display: flex; align-items: center; justify-content: space-between; height: 24px; }
        .sch-team-info { display: flex; align-items: center; gap: 8px; }
        .sch-team-logo { width: 28px; height: 28px; object-fit: contain; }
        .sch-team-name { font-size: 15px; font-weight: 700; color: var(--text-main); }
        .sch-team-score { font-size: 16px; font-weight: 700; color: var(--text-main); font-family: 'SF Mono', monospace; width: 30px; text-align: right; }
        .sch-team-score.win { color: var(--tpbl-blue); font-weight: 900; }
        .sch-team-score.lose { color: #C7C7CC; opacity: 0.8; }
        .sch-team-name.lose { color: #8E8E93; }
        .sch-card-footer { background: #FAFAFA; border-top: 1px solid #F0F0F0; padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; }
        .sch-venue { font-size: 11px; color: #8E8E93; display: flex; align-items: center; gap: 4px; font-weight: 500; cursor: pointer; transition: opacity 0.2s;}
        .sch-venue:active { opacity: 0.6; color: var(--tpbl-blue); }
        .sch-btn { padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 700; text-decoration: none; display: flex; align-items: center; gap: 4px; transition: 0.2s; white-space: nowrap; cursor: pointer;}
        .sch-btn.stats { background: #fff; border: 1px solid #E5E5EA; color: var(--text-sub); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .sch-btn.live { background: #ffebeb; color: var(--live-red); border: 1px solid rgba(255, 59, 48, 0.2); animation: pulse 2s infinite; }
        .sch-btn.ticket { background: var(--tpbl-blue); color: white; box-shadow: 0 2px 6px rgba(15, 40, 72, 0.2); }
        .sch-btn.predict { background: var(--tpbl-blue); color: var(--tpbl-gold); border: 1px solid var(--tpbl-gold); box-shadow: 0 2px 6px rgba(15, 40, 72, 0.3); }
        .sch-btn.predict:active { transform: scale(0.95); opacity: 0.9; }

        /* Teams */
        .team-selector { display: flex; overflow-x: auto; gap: 12px; padding: 4px var(--page-padding) 12px var(--page-padding); margin: 0 calc(var(--page-padding) * -1) 12px calc(var(--page-padding) * -1); scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .team-selector::-webkit-scrollbar { display: none; }
        .ts-item { display: flex; flex-direction: column; align-items: center; gap: 4px; min-width: 56px; scroll-snap-align: center; opacity: 0.4; transition: 0.3s; cursor: pointer; }
        .ts-item.active { opacity: 1; transform: scale(1.05); }
        .ts-ring { width: 50px; height: 50px; border-radius: 50%; padding: 2px; border: 2px solid transparent; display: flex; justify-content: center; align-items: center; background: #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .ts-item.active .ts-ring { border-color: var(--tpbl-blue); }
        .ts-logo { width: 40px; height: 40px; object-fit: contain; flex-shrink: 0; }
        .ts-name { font-size: 11px; font-weight: 700; color: var(--text-main); white-space: nowrap; }
        .team-dashboard { animation: fadeIn 0.3s ease-out; }
        .td-header-card { background-color: var(--team-color); border-radius: 16px; padding: 20px; display: flex; align-items: center; justify-content: space-between; color: #FFFFFF; margin-bottom: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); position: relative; overflow: hidden; background-image: linear-gradient(120deg, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0) 100%); }
        .td-header-bg-icon { position: absolute; right: -20px; bottom: -20px; width: 140px; height: 140px; opacity: 0.15; transform: rotate(-10deg); pointer-events: none; }
        .td-info-col { z-index: 2; text-shadow: 0 2px 6px rgba(0,0,0,0.25); }
        .td-name-lg { font-size: 24px; font-weight: 800; line-height: 1.2; margin-bottom: 4px; color: #fff; }
        .td-record { font-size: 13px; font-weight: 600; opacity: 0.95; font-family: 'SF Mono', monospace; display: flex; gap: 8px; align-items: center;}
        .td-rank-badge { background: rgba(0, 0, 0, 0.25); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; backdrop-filter: blur(4px); }
        
        /* Team Banner Style (NEW) */
        .team-banner-img {
            width: 100%;
            height: auto;
            border-radius: 16px;
            margin-bottom: 24px;
            display: block;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            object-fit: cover;
            min-height: 100px;
            background-color: #f0f0f0;
            animation: fadeIn 0.5s ease-out;
        }

        /* Team Awards (New) */
        .team-awards-section { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px; margin-top: 4px;}
        .ta-badge {
            background: linear-gradient(135deg, #FFF8E1 0%, #FFECB3 100%);
            color: #B48010; padding: 3px 8px; border-radius: 12px;
            font-size: 10px; font-weight: 700; display: flex; align-items: center; gap: 3px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); border: 1px solid #FFD54F;
        }

        .stats-grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
        .stat-box { background: #fff; padding: 12px; border-radius: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); display: flex; flex-direction: column; justify-content: center; gap: 2px; border: 1px solid rgba(0,0,0,0.02); }
        .sb-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .sb-label { font-size: 12px; font-weight: 600; color: var(--text-sub); display: flex; align-items: center; gap: 3px; }
        .sb-value { font-size: 22px; font-weight: 800; color: var(--tpbl-blue); font-family: 'SF Mono', monospace; line-height: 1.2; }
        .rank-tag { font-size: 10px; font-weight: 700; padding: 1px 4px; border-radius: 4px; background: rgba(15, 40, 72, 0.06); color: var(--tpbl-blue); align-self: flex-start; margin-top: 1px; }
        .rank-tag.top-1 { background: #FFFCF5; color: #A05E28; border: 1px solid #D4B07D; }
        .roster-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 12px; }
        .roster-card { background: #fff; border-radius: 14px; padding: 12px 6px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 2px 6px rgba(0,0,0,0.03); position: relative; overflow: hidden; border: 1px solid rgba(0,0,0,0.02); cursor: pointer; transition: 0.2s;}
        .roster-card:active { transform: scale(0.96); }
        .rc-img-box { width: 64px; height: 64px; margin-bottom: 6px; position: relative; display: flex; justify-content: center; align-items: flex-end; border-radius: 50%; overflow: hidden; background: #f5f5f7; border: 2px solid rgba(0,0,0,0.03); }
        .rc-img { width: 100%; height: 100%; object-fit: cover; object-position: top center;}
        .rc-num { position: absolute; top: 4px; right: 4px; background: var(--team-color, var(--tpbl-blue)); color: #fff; font-size: 9px; font-weight: 700; padding: 2px 4px; border-radius: 4px; font-family: 'SF Mono', monospace;}
        .rc-name { font-size: 13px; font-weight: 700; color: var(--text-main); margin-bottom: 1px; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .rc-pos { font-size: 11px; color: var(--text-sub); font-weight: 500; }
        .rc-meta { font-size: 10px; color: #aaa; margin-top: 1px; font-family: 'SF Mono', monospace;}

        /* --- UPDATED PLAYER CARD HEADER (Visual Fix) --- */
        .player-card-header {
            position: relative;
            background:
                linear-gradient(to bottom, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.6) 50%, rgba(0,0,0,0.9) 100%),
                radial-gradient(circle at top right, var(--team-color), #1a1a1a),
                url("data:image/svg+xml,%3Csvg width='4' height='4' viewBox='0 0 4 4' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 3h1v1H1V3zm2-2h1v1H3V1z' fill='%23ffffff' fill-opacity='0.05'/%3E%3C/svg%3E");
            background-blend-mode: normal, overlay, normal;
            border-radius: 24px;
            overflow: hidden;
            color: #fff;
            padding: 30px 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 24px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .pch-bg-logo {
            position: absolute; top: -30px; right: -50px; width: 300px; height: 300px;
            opacity: 0.12; filter: grayscale(1); transform: rotate(-15deg);
            z-index: 0; pointer-events: none;
        }
        .pch-avatar-container {
            width: 100px; height: 100px;
            border-radius: 50%;
            border: 4px solid rgba(255,255,255,0.9);
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            background: #fff;
            overflow: hidden;
            display: flex; justify-content: center; align-items: flex-end;
            z-index: 2; margin-bottom: 12px;
            position: relative;
        }
        .pch-avatar { width: 100%; height: 100%; object-fit: cover; object-position: top center; }
        .pch-info { z-index: 2; text-align: center; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }
        .pch-name { font-size: 32px; font-weight: 900; letter-spacing: -0.5px; margin-bottom: 8px; color: #fff; }
        .pch-badge-row { display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 4px; }
        .pch-pill {
            background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(8px);
            padding: 6px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2);
            font-size: 13px; font-weight: 700; color: #fff;
            text-transform: uppercase; letter-spacing: 0.5px;
            display: flex; align-items: center; gap: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .pch-jersey-num {
            font-family: 'SF Mono', monospace; font-size: 140px; font-weight: 900;
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-10deg);
            opacity: 0.08; color: #fff; z-index: 0; letter-spacing: -4px;
            pointer-events: none;
        }
        
        .stats-grid-card { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: #E5E5EA; border: 1px solid #E5E5EA; border-radius: 16px; overflow: hidden; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .sgc-item { background: #fff; padding: 14px 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .sgc-val { font-size: 18px; font-weight: 800; color: var(--tpbl-blue); font-family: 'SF Mono', monospace; line-height: 1.2; }
        .sgc-label { font-size: 10px; color: #8E8E93; font-weight: 600; text-transform: uppercase; margin-top: 2px; }

        /* 生涯代表作卡片 - 頂級重構版 */
        .best-game-card-premium {
            position: relative;
            background: #1C1C1E; /* 深灰黑色 */
            border-radius: 28px;
            padding: 24px;
            color: #fff;
            margin-bottom: 24px;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            /* 質感漸層背景 */
            background: linear-gradient(145deg, #2c2c2e 0%, #1c1c1e 100%);
        }

        /* 卡片背景浮水印 */
        .bgp-watermark {
            position: absolute;
            right: -20px;
            bottom: -30px;
            width: 220px;
            height: 220px;
            opacity: 0.05;
            filter: grayscale(1);
            transform: rotate(-15deg);
            pointer-events: none;
            z-index: 1;
        }

        .bgp-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .bgp-badge {
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 800;
            letter-spacing: 1px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #fff;
            text-transform: uppercase;
        }

        .bgp-date {
            font-family: 'SF Mono', monospace;
            font-size: 13px;
            font-weight: 700;
            color: #8E8E93;
        }

        .bgp-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            position: relative;
            z-index: 2;
        }

        .bgp-score-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .bgp-score-val {
            font-size: 80px;
            font-weight: 900;
            line-height: 0.9;
            letter-spacing: -3px;
            /* 加入一點發光效果 */
            text-shadow: 0 0 20px rgba(255,255,255,0.1);
        }

        .bgp-score-lbl {
            font-size: 15px;
            font-weight: 800;
            color: #8E8E93;
            margin-top: 8px;
            margin-left: 4px;
            letter-spacing: 2px;
        }

        .bgp-right-side {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 16px;
        }

        .bgp-vs-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bgp-vs-txt {
            font-size: 18px;
            font-weight: 800;
            color: #fff;
        }

        .bgp-vs-txt span {
            font-size: 13px;
            opacity: 0.6;
            margin-right: 4px;
            font-weight: 600;
        }

        .bgp-opp-logo {
            width: 44px;
            height: 44px;
            background: #fff;
            border-radius: 50%;
            padding: 3px;
            object-fit: contain;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }

        /* 玻璃擬態數據盒 */
        .bgp-stats-sub-box {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            display: flex;
            padding: 12px 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bgp-s-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 40px;
        }

        .bgp-s-val {
            font-size: 22px;
            font-weight: 800;
            font-family: 'SF Mono', monospace;
            color: #fff;
        }

        .bgp-s-lbl {
            font-size: 9px;
            font-weight: 700;
            color: #8E8E93;
            margin-top: 2px;
            text-transform: uppercase;
        }

        .bgp-s-divider {
            width: 1px;
            background: rgba(255, 255, 255, 0.15);
            height: 28px;
            margin: 0 15px;
            align-self: center;
        }

        /* Recent Games Table */
        .recent-games-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 12px; margin-bottom: 24px; background: #fff; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.02); }
        .recent-games-table th { background: #FAFAFA; padding: 12px 8px; color: #8E8E93; font-weight: 600; text-align: center; font-size: 10px; border-bottom: 1px solid #E5E5EA; text-transform: uppercase; }
        .recent-games-table td { padding: 14px 8px; text-align: center; border-bottom: 1px solid #F2F2F7; font-family: 'SF Mono', monospace; font-weight: 600; color: var(--text-main); font-size: 13px; }
        .recent-games-table tr:last-child td { border-bottom: none; }
        .recent-games-table td:first-child { text-align: left; padding-left: 16px; font-family: -apple-system, sans-serif; font-weight: 600; display: flex; flex-direction: column; gap: 2px; justify-content: center; }
        .recent-games-table td.highlight-col { color: var(--tpbl-blue); font-weight: 800; background: rgba(15, 40, 72, 0.02); }
        .rg-date { font-size: 10px; color: #aaa; font-weight: 500; font-family: 'SF Mono', monospace; }
        .rg-opp { display: flex; align-items: center; gap: 6px; font-size: 13px; }

        .next-game-banner { background: #fff; border-radius: 16px; padding: 16px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 12px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.02); margin-bottom: 24px; }
        .ng-info { display: flex; flex-direction: column; gap: 4px; }
        .ng-label { font-size: 10px; font-weight: 700; color: var(--live-red); text-transform: uppercase; letter-spacing: 0.5px; background: rgba(255, 59, 48, 0.08); align-self: flex-start; padding: 2px 6px; border-radius: 4px; }
        .ng-vs { font-size: 15px; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 6px; }
        .ng-date { font-size: 12px; color: #8E8E93; font-weight: 500; font-family: 'SF Mono', monospace; }

        /* Awards */
        .awards-container { margin-top: 16px; }
        .awards-section-title { font-size: 13px; font-weight: 700; color: #8E8E93; margin-bottom: 8px; padding-left: 4px; text-transform: uppercase; letter-spacing: 0.5px;}
        .annual-awards-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .aa-card {
            background: #fff; border: 1px solid #EAD8B6; border-radius: 12px;
            padding: 16px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 6px;
        }
        .aa-icon { color: #D4B07D; background: rgba(212,176,125,0.1); padding: 10px; border-radius: 50%; }
        .aa-title { font-size: 13px; font-weight: 800; color: #A05E28; }
        .aa-season { font-size: 10px; color: #C09A68; background: #FFFDF5; padding: 2px 8px; border-radius: 4px; }
        /* 橫向單月 MVP */
        .monthly-scroll { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .ma-card {
            flex: 0 0 120px; background: #fff; border-radius: 12px; padding: 12px;
            text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .ma-header { display: flex; align-items: center; gap: 4px; font-size: 9px; color: #888; font-weight: 600; text-transform: uppercase; }
        .ma-title { font-size: 12px; font-weight: 800; color: var(--tpbl-blue); }

        /* Game Detail Components */
        .game-leaders { background: #fff; border-radius: 14px; padding: 14px; margin-bottom: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); }
        .leaders-title { font-size: 13px; font-weight: 700; color: var(--tpbl-blue); margin-bottom: 10px; display: flex; align-items: center; gap: 4px; }
        .leaders-vertical { display: flex; flex-direction: column; gap: 10px; }
        .leader-row { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px dashed #f0f0f0; padding-bottom: 8px; }
        .leader-row:last-child { border-bottom: none; padding-bottom: 0; }
        .lr-player { display: flex; align-items: center; gap: 8px; flex: 1.5; }
        .lr-img { width: 44px; height: 44px; border-radius: 50%; background: #f5f5f7; object-fit: cover; border: 1px solid #eee; object-position: top center;}
        .lr-info { display: flex; flex-direction: column; }
        .lr-name { font-size: 14px; font-weight: 700; color: var(--text-main); }
        .lr-team { font-size: 11px; color: #8E8E93; font-weight: 500; }
        .lr-stats-group { display: flex; gap: 10px; text-align: center; }
        .lr-stat-item { display: flex; flex-direction: column; align-items: center; min-width: 24px; }
        .lr-val { font-size: 16px; font-weight: 800; color: var(--tpbl-blue); font-family: 'SF Mono', monospace; line-height: 1.1; }
        .lr-label { font-size: 9px; color: #aaa; font-weight: 600; margin-top: 1px; }
        .period-scroll { overflow-x: auto; width: 100%; -webkit-overflow-scrolling: touch; padding-bottom: 4px; }
        .period-table { width: 100%; min-width: 300px; margin-bottom: 0; border-collapse: separate; border-spacing: 0; font-size: 12px; white-space: nowrap; }
        .period-table th { color: #8E8E93; font-weight: 500; padding: 6px 10px; text-align: center; border-bottom: 1px solid #F0F0F0; font-size: 11px;}
        .period-table td { padding: 6px 10px; text-align: center; font-weight: 700; color: var(--tpbl-blue); font-family: 'SF Mono', monospace; border-bottom: 1px solid #F0F0F0;}
        .period-team-name { text-align: left !important; font-weight: 600; color: var(--text-main) !important; font-family: -apple-system, sans-serif !important; min-width: 60px; position: sticky; left: 0; background: #fff; z-index: 5; border-right: 1px solid #f0f0f0; }
        .comparison-card { background: #fff; border-radius: 12px; padding: 14px; margin-bottom: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); }
        .comp-title { font-size: 13px; font-weight: 700; color: var(--tpbl-blue); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .comp-row { display: flex; align-items: center; margin-bottom: 8px; height: 20px; }
        .comp-label { flex: 0 0 70px; text-align: center; font-size: 10px; color: #888; font-weight: 600; order: 2; }
        .comp-side { flex: 1; display: flex; align-items: center; height: 100%; position: relative; overflow: hidden; }
        .comp-side.left { justify-content: flex-end; order: 1; margin-right: 6px; }
        .comp-side.right { justify-content: flex-start; order: 3; margin-left: 6px; }
        .comp-wrapper { display: flex; align-items: center; width: 100%; }
        .comp-side.left .comp-wrapper { justify-content: flex-end; }
        .comp-side.right .comp-wrapper { justify-content: flex-start; }
        .comp-bar-bg { flex: 1; height: 5px; background: #F2F2F7; border-radius: 3px; position: relative; max-width: 100%; }
        .comp-bar { height: 100%; border-radius: 3px; transition: width 0.5s ease; position: absolute; top: 0; }
        .comp-bar.left { right: 0; background-color: var(--bar-gray); }
        .comp-bar.right { left: 0; background-color: var(--bar-gray); }
        .comp-bar.left.winner { background-color: var(--tpbl-blue); }
        .comp-bar.right.winner { background-color: var(--tpbl-blue); }
        .comp-val { font-size: 11px; font-weight: 700; font-family: 'SF Mono', monospace; flex-shrink: 0; color: #333; }
        .comp-side.left .comp-val { margin-right: 6px; }
        .comp-side.right .comp-val { margin-left: 6px; }
        .flow-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 8px; }
        .flow-table th { color: #8E8E93; font-weight: 500; padding: 6px 4px; text-align: center; border-bottom: 1px solid #eee; font-size: 10px; }
        .flow-table td { padding: 8px 4px; text-align: center; font-weight: 700; color: var(--text-main); border-bottom: 1px solid #eee; font-family: 'SF Mono', monospace; }
        .flow-team-name { text-align: left !important; padding-left: 8px; font-family: -apple-system, BlinkMacSystemFont, sans-serif; color: var(--text-sub); width: 80px; white-space: nowrap;}
        .modal-tabs { display: flex; background: #E5E5EA; padding: 2px; border-radius: 9px; margin-bottom: 12px; }
        .modal-tab-btn { flex: 1; border: none; background: none; padding: 8px; font-size: 13px; font-weight: 600; border-radius: 7px; color: var(--text-sub); transition: 0.2s; cursor: pointer; }
        .modal-tab-btn.active { background: #fff; color: var(--text-main); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .modal-score-card { background: #fff; border-radius: 14px; padding: 16px; margin-bottom: 12px; display: flex; flex-direction: column; gap: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .msc-main { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .m-score { font-size: 32px; font-weight: 800; color: var(--tpbl-blue); }
        .boxscore-section { margin-bottom: 24px; background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.03); }
        .boxscore-title { padding: 10px 12px; background: #FAFAFA; font-weight: 700; color: var(--tpbl-blue); border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 6px; font-size: 13px;}
        .bs-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        
        .bs-table { width: 100%; border-collapse: collapse; font-size: 11px; white-space: nowrap; }
        .bs-table th { background: #F5F5F7; padding: 8px 12px; font-weight: 600; color: #888; text-align: center; border-bottom: 1px solid #eee; font-size: 10px;}
        .bs-table td { padding: 8px 8px; border-bottom: 1px solid #eee; text-align: center; font-weight: 500; font-family: 'SF Mono', monospace; vertical-align: middle; }
        .bs-table th:first-child, .bs-table td:first-child { position: sticky; left: 0; background: #fff; z-index: 10; border-right: 1px solid #f0f0f0; text-align: left; padding-left: 10px; font-family: -apple-system, sans-serif; font-weight: 600; }
        .bs-table th:first-child { background: #F5F5F7; }
        .player-head-cell { display: flex; align-items: center; gap: 6px; cursor: pointer; }
        .player-head-cell:active { opacity: 0.6; }
        .player-headshot { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; background: #f0f0f0; border: 1px solid #eee;}
        .separator-row .sticky-sep { position: sticky; left: 0; z-index: 30; background: #F2F2F7; color: #888; font-size: 10px; font-weight: 700; letter-spacing: 1px; padding: 4px 4px 4px 10px; text-align: left; border: none; }
        .separator-row .filler-sep { background: #F2F2F7; border: none; }
        .dnp-row td { color: #ccc; }
        .dnp-row td:first-child { color: #aaa; }
        
        /* New: Team Total Style */
        .total-row-highlight { background: var(--tpbl-blue) !important; color: var(--tpbl-gold) !important; font-weight: 800 !important; }
        .total-row-highlight td { border-bottom: none !important; color: inherit !important; font-size: 12px; padding-top: 10px; padding-bottom: 10px; }
        .total-row-highlight .sticky-sep { background: var(--tpbl-blue) !important; color: var(--tpbl-gold) !important; border-right-color: rgba(255,255,255,0.1) !important; }

        .seg-control { display: flex; background: #E5E5EA; padding: 2px; border-radius: 9px; margin-bottom: 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .seg-btn { flex: 1; border: none; background: none; padding: 8px 4px; font-size: 12px; font-weight: 600; border-radius: 7px; color: var(--text-sub); transition: 0.2s; cursor: pointer; white-space: nowrap; min-width: 50px;}
        .seg-btn.active { background: #fff; color: var(--text-main); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        /* Tab Bar */
        .tab-bar { position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.92); border-top: 0.5px solid rgba(0,0,0,0.1); padding-bottom: env(safe-area-inset-bottom); display: flex; justify-content: space-around; backdrop-filter: blur(20px); z-index: 90; }
        .tab-btn { background: none; border: none; padding: 10px 0 6px 0; width: 33%; display: flex; flex-direction: column; align-items: center; gap: 4px; color: #C7C7CC; font-size: 10px; font-weight: 500; }
        .tab-btn.active { color: var(--tpbl-blue); font-weight: 600; }
        
        /* Compare Page Selectors */
        .compare-selectors { display: flex; gap: 12px; margin-bottom: 20px; background: #fff; padding: 16px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .cs-col { flex: 1; display: flex; flex-direction: column; gap: 6px; }
        .cs-label { font-size: 11px; font-weight: 600; color: #8E8E93; text-align: center; }
        .cs-select {
            width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #E5E5EA;
            font-size: 13px; font-weight: 600; color: var(--tpbl-blue); background: #F9F9F9;
            text-align: center; appearance: none; -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238E8E93' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 8px center;
        }

        .hidden { display: none !important; }
        .loading { text-align: center; padding: 60px 20px; color: #999; font-size: 12px; }
        .error-msg { text-align: center; padding: 40px 20px; color: #FF3B30; font-weight: 500; font-size: 13px; }
        .retry-btn { margin-top: 12px; padding: 6px 14px; background: #fff; border: 1px solid #ccc; border-radius: 8px; cursor: pointer; color: #555; font-size: 12px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Favorites */
        /* 收藏按鈕優化版 */
        .pch-fav-btn {
            margin-left: auto; /* 關鍵：將按鈕推至最右邊 */
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 1.5px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.15); /* 稍微降低平時亮度 */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            flex-shrink: 0; /* 防止按鈕被擠壓 */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .pch-fav-btn:active {
            transform: scale(0.9);
        }

        /* 選中狀態：使用動態傳入的球隊主色 */
        .pch-fav-btn.active {
            background: #FFFFFF; /* 背景改為純白，襯托主色圖示 */
            color: var(--team-accent); /* 圖示顏色變為球隊色 */
            border-color: #FFFFFF;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .pch-fav-btn.active i {
            filter: drop-shadow(0 0 2px rgba(255, 204, 0, 0.5));
        }
        
        .fav-list { display: flex; gap: 12px; overflow-x: auto; padding: 4px 4px 12px 4px; margin: 0 -4px; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; }
        .fav-list::-webkit-scrollbar { display: none; }
        .fav-item { flex: 0 0 auto; display: flex; flex-direction: column; align-items: center; width: 64px; cursor: pointer; scroll-snap-align: start; }
        .fav-avatar { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; border: 2px solid var(--tpbl-blue); padding: 2px; background: #fff; }
        .fav-name { font-size: 11px; font-weight: 600; margin-top: 4px; text-align: center; white-space: nowrap; width: 100%; overflow: hidden; text-overflow: ellipsis; color: var(--text-main); }

        /* AI Prediction Modal */
        .ai-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s;
        }
        .ai-modal-overlay.active { opacity: 1; visibility: visible; }
        .ai-modal-content {
            background: #fff; width: 85%; max-width: 320px; border-radius: 20px;
            padding: 24px; text-align: center; position: relative;
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .ai-modal-overlay.active .ai-modal-content { transform: scale(1); }
        .ai-close-btn {
            position: absolute; top: 12px; right: 12px; background: #f2f2f7; border: none;
            width: 28px; height: 28px; border-radius: 50%; color: #888;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
        }
        .ai-loading-icon { color: var(--tpbl-gold); animation: pulse-ring 1.5s infinite; margin-bottom: 16px; }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(212, 176, 125, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(212, 176, 125, 0); } 100% { box-shadow: 0 0 0 0 rgba(212, 176, 125, 0); } }
        .ai-result-title { font-size: 14px; font-weight: 700; color: #8E8E93; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .ai-winner-name { font-size: 24px; font-weight: 900; color: var(--tpbl-blue); margin-bottom: 4px; }
        .ai-win-prob { font-size: 32px; font-weight: 800; color: var(--tpbl-gold); font-family: 'SF Mono', monospace; margin-bottom: 16px; display: inline-block; border-bottom: 2px solid #f0f0f0; padding-bottom: 4px; }
        .ai-analysis-box { background: #FAFAFA; border-radius: 12px; padding: 12px; text-align: left; margin-bottom: 12px; border: 1px solid #eee; }
        .ai-ab-title { font-size: 11px; font-weight: 700; color: #8E8E93; margin-bottom: 4px; display: flex; align-items: center; gap: 4px; }
        .ai-ab-text { font-size: 13px; font-weight: 600; color: var(--text-main); line-height: 1.4; }
        
        /* --- Highlights/News Grid (NEW) --- */
        .highlights-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
            margin-bottom: 20px;
        }
        .hl-card {
            background: #fff; border-radius: 12px; overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column;
            text-decoration: none; color: inherit; transition: transform 0.2s;
        }
        .hl-card:active { transform: scale(0.96); }
        .hl-img-box {
            position: relative; width: 100%; padding-top: 56.25%; /* 16:9 */
            background: #000; overflow: hidden;
        }
        .hl-img {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; opacity: 0.9;
        }
        .hl-play-icon {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 32px; height: 32px; background: rgba(0,0,0,0.5);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.3); color: #fff;
        }
        .hl-info { padding: 10px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .hl-title { font-size: 12px; font-weight: 700; line-height: 1.3; margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;}
        .hl-date { font-size: 10px; color: #8E8E93; font-weight: 500; display: flex; align-items: center; gap: 4px; }
        
        /* --- Season Stats Table Styles (NEW) --- */
        .season-stats-container { background: #fff; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 24px; overflow: hidden; border: 1px solid rgba(0,0,0,0.02); }
        .season-table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 4px; }
        .season-table { width: 100%; min-width: 450px; border-collapse: collapse; font-size: 12px; }
        .season-table th { background: #FAFAFA; color: #8E8E93; font-weight: 600; padding: 10px 6px; text-align: center; border-bottom: 1px solid #E5E5EA; white-space: nowrap; font-size: 11px; }
        .season-table td { padding: 12px 6px; text-align: center; font-family: 'SF Mono', monospace; font-weight: 600; color: var(--text-main); border-bottom: 1px solid #F2F2F7; white-space: nowrap; }
        .season-table tr:last-child td { border-bottom: none; }
        
        /* Specific Styles for 3-Row Layout */
        .season-col-fixed { position: sticky; left: 0; background: #fff; z-index: 5; border-right: 1px solid #eee; font-weight: 700 !important; color: var(--tpbl-blue) !important; font-family: -apple-system, sans-serif !important; min-width: 60px; }
        
        /* Row 1: S2 (Current) */
        .s2-row td { background: rgba(15, 40, 72, 0.02); font-weight: 800; font-size: 14px; }
        .s2-row .season-col-fixed { background: #F5F7FA; color: var(--tpbl-blue); }
        
        /* Row 2: S1 (Previous) */
        .s1-row td { color: #8E8E93; font-weight: 500; font-size: 13px; }
        .s1-row .season-col-fixed { color: #8E8E93 !important; }
        
        /* Row 3: Trend (Diff) */
        .trend-row td { background: #fff; padding-top: 8px; padding-bottom: 8px; }
        .trend-row .season-col-fixed { font-size: 10px; color: #ccc !important; text-transform: uppercase; letter-spacing: 1px; }
        
        /* 賽季數據趨勢 Badge */
        .badge-pill {
            display: inline-flex; align-items: center; justify-content: center;
            border-radius: 6px; padding: 2px 8px; font-size: 11px; font-weight: 800;
        }
        .bp-up { background: rgba(255, 59, 48, 0.1); color: #FF3B30; }
        .bp-down { background: rgba(52, 199, 89, 0.1); color: #34C759; }
        .bp-flat { display: none; }
        
        /* Chart Container */
        .chart-card {
            background: #fff; border-radius: 16px; padding: 20px;
            margin-bottom: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.04);
            border: 1px solid rgba(0,0,0,0.02);
        }
        .chart-container {
            position: relative; margin: auto; height: 260px; width: 100%; max-width: 320px;
            display: flex; justify-content: center; align-items: center; /* Fix 1: Centering container */
        }

        /* Team Awards Badge Style */
        .team-awards-section { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px; margin-top: 4px; justify-content: flex-start; }
        .ta-badge {
            background: linear-gradient(135deg, #FFF8E1 0%, #FFECB3 100%);
            color: #B48010; padding: 3px 8px; border-radius: 12px;
            font-size: 10px; font-weight: 700; display: flex; align-items: center; gap: 3px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); border: 1px solid #FFD54F; white-space: nowrap;
        }
        /* --- 數據排行榜 專業版樣式 --- */
        .stats-list-card {
            background: #fff; border-radius: 16px; padding: 4px 0; margin-top: 8px;  margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.01);
        }
        .rank-row {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px;
            border-bottom: 0.5px solid #f2f2f7; transition: background 0.2s;
        }
        .rank-row:active { background: #f9f9f9; }
        .rank-row:last-child { border-bottom: none; }

        /* 排名數字：統一字體，無特殊色 */
        .rank-index {
            width: 20px; font-size: 13px; font-weight: 800; color: #8E8E93;
            font-family: 'SF Mono', monospace; text-align: center;
        }

        /* 頭像與球隊徽章 */
        .rank-photo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #f8f8fa; border: 1px solid #eee; }
        .rank-logo-sm { width: 18px; height: 18px; object-fit: contain; }

        .rank-main-info { flex: 1; display: flex; flex-direction: column; gap: 2px; }
        .rank-name-txt { font-size: 14px; font-weight: 700; color: var(--text-main); }
        .rank-meta-txt { font-size: 11px; color: var(--text-sub); font-weight: 500; display: flex; align-items: center; gap: 4px; }

        /* 數據數值：統一深藍色與 Mono 字體 */
        .rank-val-txt {
            font-family: 'SF Mono', monospace; font-weight: 800; font-size: 17px;
            color: var(--tpbl-blue); text-align: right; min-width: 50px;
        }
        /* 單週 MVP 新聞卡片樣式 */
        .weekly-mvp-scroll {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding: 4px 0 12px 0;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }
        .weekly-mvp-scroll::-webkit-scrollbar { display: none; }

        /* 確保圖片鋪滿且有基本底色 */
        /* 修改原本的 .wmvp-post-card */
        .wmvp-post-card {
            flex: 0 0 85%; /* 讓下一張卡片露出一點點，提示可以滑動 */
            scroll-snap-align: center;
            position: relative;
            border-radius: 20px;
            height: 380px;
            overflow: hidden;
            background-color: #0F2848;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            margin-right: 4px;
        }

        .wmvp-post-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: opacity 0.3s;
        }

        /* 底部文字遮罩：加強黑影深度，確保文字清晰 */
        .wmvp-post-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 24px 20px 16px 20px;
            background: linear-gradient(to top,
                rgba(0,0,0,0.95) 0%,
                rgba(0,0,0,0.6) 50%,
                transparent 100%);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .wmvp-post-title {
            color: #fff;
            font-size: 19px; /* 稍微加大字體 */
            font-weight: 800;
            line-height: 1.25;
            margin-bottom: 6px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .wmvp-post-tag {
            background: var(--tpbl-gold);
            color: var(--tpbl-blue);
            font-size: 10px;
            font-weight: 800;
            padding: 2px 8px;
            border-radius: 4px;
            align-self: flex-start;
            margin-bottom: 8px;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .wmvp-post-date {
            color: rgba(255,255,255,0.6);
            font-size: 11px;
            font-weight: 600;
        }
    </style>
</head>
<body>

    <!-- Loading Splash Screen -->
    <div id="splash-screen">
        <div class="splash-logo">TPBL <div class="splash-star"></div></div>
        <div class="splash-spinner"></div>
    </div>

    <!-- Main Header -->
    <header class="main-header">
        <div class="header-left"></div>
        <div class="brand-logo-center">TPBL <div class="brand-star"></div></div>
        <div class="header-right">
             <div id="live-pulse" class="live-indicator"></div>
             <span class="season-badge nums">2025-26</span>
        </div>
    </header>

    <main id="app-container"></main>

    <!-- Game Detail Page (Full Screen) -->
    <div id="game-page" class="sub-page">
        <div class="nav-bar">
            <div class="nav-left"><button class="nav-back-btn" onclick="closeGameModal()"><i data-lucide="chevron-left" width="24"></i></button></div>
            <div class="nav-title">比賽詳情</div>
            <div class="nav-right"></div>
        </div>
        <div id="modal-body" class="sub-page-body"><div class="loading">載入數據中...</div></div>
    </div>

    <!-- Player Detail Page (Full Screen) -->
    <div id="player-page" class="sub-page">
        <div class="nav-bar">
            <div class="nav-left"><button class="nav-back-btn" onclick="closePlayerModal()"><i data-lucide="chevron-left" width="24"></i></button></div>
            <div class="nav-title">球員數據</div>
            <div class="nav-right"></div>
        </div>
        <div id="player-modal-body" class="sub-page-body"><div class="loading">載入球員資料...</div></div>
    </div>

    <!-- Team Comparison Page -->
    <div id="compare-page" class="sub-page">
        <div class="nav-bar">
            <div class="nav-left"><button class="nav-back-btn" onclick="closeCompareModal()"><i data-lucide="chevron-left" width="24"></i></button></div>
            <div class="nav-title">球隊比較</div>
            <div class="nav-right"></div>
        </div>
        <div id="compare-body" class="sub-page-body"></div>
    </div>

    <!-- AI Prediction Modal -->
    <div id="ai-modal" class="ai-modal-overlay">
        <div class="ai-modal-content">
            <button class="ai-close-btn" onclick="closeAiModal()"><i data-lucide="x" width="16"></i></button>
            <div id="ai-modal-body"></div>
        </div>
    </div>

    <nav class="tab-bar">
        <button class="tab-btn active" onclick="switchMainTab('home')"><i data-lucide="layout-grid" width="22"></i>看板</button>
        <button class="tab-btn" onclick="switchMainTab('teams')"><i data-lucide="shield" width="22"></i>球隊</button>
        <button class="tab-btn" onclick="switchMainTab('stats')"><i data-lucide="bar-chart-3" width="22"></i>數據</button>
        <button class="tab-btn" onclick="switchMainTab('schedule')"><i data-lucide="calendar-days" width="22"></i>賽程</button>
    </nav>

    <script>
        // --- PROXY FETCH ---
        async function fetchJson(url) {
             const ts = Date.now();
             const targetUrl = url + (url.includes('?') ? '&' : '?') + 't=' + ts;
             const encoded = encodeURIComponent(targetUrl);
             const proxies = [
                 `https://corsproxy.io/?${targetUrl}`,
                 `https://thingproxy.freeboard.io/fetch/${targetUrl}`,
                 `https://api.allorigins.win/raw?url=${encoded}`
             ];
             for(let proxyUrl of proxies) {
                 try {
                     const controller = new AbortController();
                     const id = setTimeout(() => controller.abort(), 6000);
                     const res = await fetch(proxyUrl, { signal: controller.signal });
                     clearTimeout(id);
                     if(res.ok) return await res.json();
                 } catch(e) { console.warn(`Proxy failed: ${proxyUrl}`); }
             }
             throw new Error("Unable to connect to data source.");
        }

        const API_GAMES = 'https://api.tpbl.basketball/api/seasons/2/games';
        const API_GAMES_S1 = 'https://api.tpbl.basketball/api/seasons/1/games';
        // 請確保這行網址是這個
        const API_NEWS = 'https://api.tpbl.basketball/api/teams/1/posts?type=news&page=1';
        let globalMvpPosts = []; // 存放過濾後的單週 MVP 文章
        let globalAllNews = []; // 儲存所有新聞供球員頁面比對
        const API_STANDINGS = 'https://api.tpbl.basketball/api/divisions/9/games/standings';
        const API_TEAM_STATS = 'https://api.tpbl.basketball/api/games/stats/top-teams?division_id=9';
        const API_PLAYERS = 'https://api.tpbl.basketball/api/divisions/9/players';
        const API_VOTES_S1 = 'https://api.tpbl.basketball/api/teams/1/votes/events/awards?season_id=1&type=monthly';
        const API_VOTES_S2 = 'https://api.tpbl.basketball/api/teams/1/votes/events/awards?season_id=2&type=monthly';
        const API_VOTES_ANNUAL_S1 = 'https://api.tpbl.basketball/api/teams/1/votes/events/awards?season_id=1&type=annual';
        const API_VOTES_ANNUAL_S2 = 'https://api.tpbl.basketball/api/teams/1/votes/events/awards?season_id=2&type=annual';

        const LOGOS = { "海神": "https://i.postimg.cc/KYtTwqdg/aquas_CB_Rq9NB.webp", "夢想家": "https://i.postimg.cc/ZRZNSPSL/dreamers_8u_P5Ali_T.webp", "攻城獅": "https://i.postimg.cc/FRmS4b4n/lioneers_DTfku_EJZ.webp", "戰神": "https://i.postimg.cc/V61t898V/mars_Bb_DWfk_G6.webp", "特攻": "https://i.postimg.cc/Qts73g3J/dea_BEf_Nf_G39.webp", "國王": "https://i.postimg.cc/XJ35bKb2/kings_Dsun_MN_K.webp", "雲豹": "https://i.postimg.cc/XJ35bKbH/leopards_BGzl_SG8M.webp" };
        const KEYWORD_ORDER = ["攻城獅", "特攻", "國王", "戰神", "雲豹", "夢想家", "海神"];
        const TEAM_COLORS = { "戰神": "#DD827C", "國王": "#F6ECA7", "雲豹": "#8DA49B", "海神": "#99AEE0", "特攻": "#F3E19E", "攻城獅": "#A39AC0", "夢想家": "#CEDAAA" };
        const DEFAULT_AVATAR = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' stroke='white' stroke-width='1' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2'/%3E%3Ccircle cx='12' cy='7' r='4'/%3E%3C/svg%3E";
        const POS_MAP = { "PointGuard": "PG", "ShootingGuard": "SG", "SmallForward": "SF", "PowerForward": "PF", "Center": "C", "PointGuardAndShootingGuard": "G", "SmallForwardAndPowerForward": "F" };
        const TEAM_TICKET_URLS = { "攻城獅": "https://tixcraft.com/activity/detail/25_lioneers", "特攻": "https://tix.ctbcsports.com/DEA", "國王": "https://newtaipeikings.kktix.cc/events/lojke", "戰神": "https://www.famiticket.com.tw/Home/Activity/Info/bgBRAG0AcABKAE0AMQB5AGgAWQBVAGgANQBEAEwARwBMAEcAYwBvAG8AMQAvAGkATgBqAC8AcQBtAEYAcQBMAEkAdABXAHAANABqAEMAYwB2AEYAUQA9AA2", "雲豹": "https://leopards.kktix.cc/events/afrehwe", "夢想家": "https://ticket.ibon.com.tw/ActivityInfo/Details/39190", "海神": "https://www.famiticket.com.tw/Home/Activity/Info/bgBRAG0AcABKAE0AMQB5AGgAWQBVAGgANQBEAEwARwBMAEcAYwBvAG8AMQAvAGkATgBqAC8AcQBtAEYAcQBMAEkAdABXAHAANABqAEMAYwB2AEYAUQA9AA2" };

        function getLogo(teamName, defaultLogo) { for (const key in LOGOS) { if (teamName && teamName.includes(key)) return LOGOS[key]; } return defaultLogo || "https://via.placeholder.com/60"; }
        function getTicketLink(fullTeamName) { for (const key in TEAM_TICKET_URLS) { if (fullTeamName && fullTeamName.includes(key)) return TEAM_TICKET_URLS[key]; } return "https://tpbl.basketball/"; }
        function getShortName(fullName) { if(!fullName) return ''; for (const key of KEYWORD_ORDER) { if (fullName.includes(key)) return key; } return fullName.substring(0, 4); }
        function getTeamColor(teamName) { const short = getShortName(teamName); return TEAM_COLORS[short] || "#0F2848"; }
        function formatPos(posStr) { return POS_MAP[posStr] || posStr || '-'; }
        function getAwardIcon(title) { if (!title) return 'trophy'; const t = title.toLowerCase(); if (t.includes('defen') || t.includes('防守')) return 'shield'; if (t.includes('assist') || t.includes('助攻')) return 'helping-hand'; if (t.includes('popular') || t.includes('人氣')) return 'heart'; if (t.includes('rookie') || t.includes('新人')) return 'sprout'; if (t.includes('first') || t.includes('第一隊')) return 'star'; if (t.includes('coach') || t.includes('教練')) return 'clipboard-list'; if (t.includes('sixth') || t.includes('第六人')) return 'zap'; return 'crown'; }
        function formatDate(date) { const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        function openMap(venueName) { if (!venueName) return; event.stopPropagation(); const query = encodeURIComponent(venueName); window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank'); }

        // Color helper
        function hexToRgba(hex, alpha) {
            let c;
            if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
                c= hex.substring(1).split('');
                if(c.length== 3){ c= [c[0], c[0], c[1], c[1], c[2], c[2]]; }
                c= '0x'+c.join('');
                return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+','+alpha+')';
            }
            return hex; // Fallback
        }

        let globalGames = [], globalStandings = [], globalTeamStats = null, globalPlayers = [], globalAwards = [], playerMap = {};
        let currentScheduleTab = 'future', selectedStatsTeam = null, processedStats = {}, refreshInterval = null;
        let compareTeamA = null, compareTeamB = null;
        let favoritePlayerIds = JSON.parse(localStorage.getItem('tpbl_favorites')) || [];
        
        // --- NEW: Game Detailed Data Cache ---
        let currentDetailedGameData = null;

        function toggleFavorite(id) {
            const index = favoritePlayerIds.indexOf(id);
            if (index > -1) {
                favoritePlayerIds.splice(index, 1);
            } else {
                favoritePlayerIds.push(id);
            }
            localStorage.setItem('tpbl_favorites', JSON.stringify(favoritePlayerIds));
            
            // 更新球員詳情頁的按鈕狀態
            const btn = document.getElementById(`fav-btn-${id}`);
            if(btn) {
                const isActive = favoritePlayerIds.includes(id);
                btn.classList.toggle('active', isActive);
                btn.innerHTML = isActive
                    ? `<i data-lucide="star" fill="currentColor" width="22"></i>`
                    : `<i data-lucide="star" width="22"></i>`;
                lucide.createIcons(); // 關鍵：必須重新渲染圖示
            }
            
            // 如果在主首頁，順便更新一下首頁的關注列表
            if(document.querySelector('.tab-bar .tab-btn:first-child').classList.contains('active')) {
                renderHome();
            }
        }

        function hideSplashScreen() { const splash = document.getElementById('splash-screen'); if(splash) setTimeout(() => splash.classList.add('hidden'), 500); }

        async function init() {
            try {
                await fetchData(); renderHome(); lucide.createIcons(); hideSplashScreen();
                initSwipeGesture(document.getElementById('game-page'), closeGameModal);
                initSwipeGesture(document.getElementById('player-page'), closePlayerModal);
                initSwipeGesture(document.getElementById('compare-page'), closeCompareModal);
                if (refreshInterval) clearInterval(refreshInterval);
                refreshInterval = setInterval(async () => { await fetchData(); updateHomeUI(); }, 15000);
            } catch (e) { hideSplashScreen(); document.getElementById('app-container').innerHTML = `<div class="error-msg"><i data-lucide="wifi-off" width="32"></i><br><br>暫時無法連接資料庫<br><span style="font-size:12px; opacity:0.7">請重新整理頁面</span><br><button class="retry-btn" onclick="location.reload()">重新載入</button></div>`; lucide.createIcons(); }
        }
        
        //排行榜api
        let globalTopPlayers = null, globalTopTeams = null;
        const API_TOP_PLAYERS = 'https://api.tpbl.basketball/api/games/stats/top-players?division_id=9';
        const API_TOP_TEAMS = 'https://api.tpbl.basketball/api/games/stats/top-teams?division_id=9';
        async function fetchData() {
            if (globalPlayers.length === 0) { try { const pJson = await fetchJson(API_PLAYERS); globalPlayers = pJson.data || pJson; globalPlayers.forEach(p => { let imgUrl = ""; if(p.images && p.images.length > 0) { const sm = p.images.find(i => i.key === 'sm'); const md = p.images.find(i => i.key === 'md'); imgUrl = sm ? sm.url : (md ? md.url : p.images[0].url); } playerMap[p.name.replace(/\s/g, '')] = imgUrl; }); } catch(e) {} }
            const [gamesRes, gamesS1Res, standingsRes, statsRes, votesS1, votesS2, votesAnnS1, votesAnnS2, newsRes] = await Promise.allSettled([
                    fetchJson(API_GAMES),
                    fetchJson(API_GAMES_S1),
                    fetchJson(API_STANDINGS),
                    fetchJson(API_TEAM_STATS),
                    fetchJson(API_VOTES_S1),
                    fetchJson(API_VOTES_S2),
                    fetchJson(API_VOTES_ANNUAL_S1),
                    fetchJson(API_VOTES_ANNUAL_S2),
                    fetchJson(API_NEWS) // 抓取新聞
                ]);
            if (gamesRes.status === 'fulfilled') globalGames = gamesRes.value.data || gamesRes.value;
            if (gamesS1Res.status === 'fulfilled') {
                const s1Games = gamesS1Res.value.data || gamesS1Res.value;
                if(Array.isArray(s1Games)) globalGames = [...globalGames, ...s1Games];
            }
            if (standingsRes.status === 'fulfilled') globalStandings = standingsRes.value.data || standingsRes.value;
            if (statsRes.status === 'fulfilled') { globalTeamStats = statsRes.value.data || statsRes.value; processStatsData(); }
            let awards = []; [votesS1, votesS2, votesAnnS1, votesAnnS2].forEach(p => { if (p.status === 'fulfilled' && p.value.result) awards = awards.concat(p.value.result); }); globalAwards = awards;
            // 在 fetchData 函數內修改新聞處理部分
            if (newsRes.status === 'fulfilled') {
                            // 1. 確保拿到陣列 (相容不同 API 層級)
                            const raw = newsRes.value.data || newsRes.value.result || [];
                            const newsData = Array.isArray(raw) ? raw : (raw.data || []);
                            globalAllNews = newsData; // <--- 關鍵：存入這行，讓球員頁面找得到資料

                            // 2. 過濾單週 (取最新 1 篇)
                            const weekly = newsData.filter(post => {
                                const t = post.title || "";
                                return t.includes('週') && (t.includes('MVP') || t.includes('殊榮'));
                            }).slice(0, 1);

                            // 3. 過濾單月 (取最新 2 篇，包含特殊字、獎盃、或月+MVP)
                            const monthly = newsData.filter(post => {
                                const t = post.title || "";
                                const hasFancyType = /[\u{1D400}-\u{1D7FF}]/u.test(t);
                                return hasFancyType || t.includes('𝑷𝒍𝒂𝒚𝒆𝒓 𝑶𝒇 𝑻𝒉𝒆 𝑴𝒐𝒏𝒕𝒉') || t.includes('🏆') || (t.includes('月') && t.includes('MVP'));
                            }).slice(0, 2);

                            // 4. 重要：變數名稱請統一使用原本檔案中的 globalMvpPosts
                            globalMvpPosts = [...weekly, ...monthly];
                        }
            //排行榜數據
            
            const [tpRes, ttRes] = await Promise.allSettled([
                    fetchJson('https://api.tpbl.basketball/api/games/stats/top-players?division_id=9'),
                    fetchJson('https://api.tpbl.basketball/api/games/stats/top-teams?division_id=9')
                ]);
                if (tpRes.status === 'fulfilled') globalTopPlayers = tpRes.value.data || tpRes.value;
                if (ttRes.status === 'fulfilled') globalTopTeams = ttRes.value.data || ttRes.value;
                
            
        }

        function processStatsData() {
            if (!globalTeamStats) return;
            const teamsMap = {};
            const CATEGORIES = [ { key: 'won_score_per_match', label: '場均得分', isPct: false, icon: 'target' }, { key: 'rebounds_per_match', label: '場均籃板', isPct: false, icon: 'circle' }, { key: 'assists_per_match', label: '場均助攻', isPct: false, icon: 'send' }, { key: 'steals_per_match', label: '場均抄截', isPct: false, icon: 'hand' }, { key: 'blocks_per_match', label: '場均阻攻', isPct: false, icon: 'shield' }, { key: 'three_pointers_percentage', label: '三分%', isPct: true, icon: 'percent' }, { key: 'free_throws_percentage', label: '罰球%', isPct: true, icon: 'percent' }, { key: 'lost_score_per_match', label: '場均失分', isPct: false, inverse: true, icon: 'shield-alert' } ];
            
            CATEGORIES.forEach(cat => {
                const list = globalTeamStats[cat.key];
                if (!list || !Array.isArray(list)) return;
                const sortedList = [...list].sort((a, b) => cat.inverse ? a.value - b.value : b.value - a.value);
                sortedList.forEach((item, index) => {
                    if(!item.team) return;
                    const teamName = item.team.name;
                    if (!teamsMap[teamName]) { teamsMap[teamName] = { name: teamName, logo: item.team.meta?.logo, stats: [] }; }
                    teamsMap[teamName].stats.push({ label: cat.label, value: item.value, rank: index + 1, isPct: cat.isPct, icon: cat.icon });
                });
            });
            processedStats = teamsMap;
        }

        // --- RENDER HOME ---
        function renderHome() {
            const container = document.getElementById('app-container'); container.innerHTML = '';
            const wrapper = document.createElement('div'); wrapper.className = 'container';
            
            // Favorites
            if (favoritePlayerIds.length > 0 && globalPlayers.length > 0) {
                let favItems = ''; favoritePlayerIds.forEach(id => { const p = globalPlayers.find(gp => gp.id === id); if (p) { let img = DEFAULT_AVATAR; if(p.images && p.images.length > 0) { const sm = p.images.find(i => i.key === 'sm'); img = sm ? sm.url : p.images[0].url; } const teamColor = getTeamColor(p.team.name); favItems += `<div class="fav-item" onclick="openPlayerProfile(${p.id})"><img src="${img}" class="fav-avatar" style="border-color:${teamColor}"><div class="fav-name">${p.name}</div></div>`; } });
                if (favItems) wrapper.innerHTML += `<div class="section-header" style="margin-top:0"><div class="section-title">關注球員</div></div><div class="fav-list">${favItems}</div>`;
            }

            const now = new Date(); const currentDay = now.getDay(); const distancePastMonday = (currentDay === 0 ? 6 : currentDay - 1);
            const monday = new Date(now); monday.setDate(now.getDate() - distancePastMonday);
            const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);
            const startStr = formatDate(monday); const endStr = formatDate(sunday);
            const weeklyGames = globalGames.filter(g => g.game_date >= startStr && g.game_date <= endStr);
            const todayDateStr = formatDate(now);
            const gamesToday = weeklyGames.filter(g => g.game_date === todayDateStr).sort((a, b) => a.game_time.localeCompare(b.game_time));
            const gamesFuture = weeklyGames.filter(g => g.game_date > todayDateStr).sort((a, b) => (a.game_date !== b.game_date) ? a.game_date.localeCompare(b.game_date) : a.game_time.localeCompare(b.game_time));
            const gamesPast = weeklyGames.filter(g => g.game_date < todayDateStr).sort((a, b) => (a.game_date !== b.game_date) ? a.game_date.localeCompare(b.game_date) : a.game_time.localeCompare(b.game_time));
            let displayGames = (gamesToday.length > 0) ? [...gamesToday, ...gamesFuture, ...gamesPast] : [...gamesPast, ...gamesFuture];
            
            let scrollTargetId = null; const targetGame = displayGames.find(g => g.status === 'LIVE' || g.status === 'IN_PROGRESS') || displayGames.find(g => g.status === 'UPCOMING' || g.status === 'COMING_SOON'); if (targetGame) scrollTargetId = `game-card-${targetGame.id}`;

            wrapper.innerHTML += `<div class="section-header"><div class="section-title">本週賽程</div><div class="section-date nums">${startStr.slice(5).replace('-','/')} - ${endStr.slice(5).replace('-','/')}</div></div>`;
            const sbWrapper = document.createElement('div'); sbWrapper.className = `smart-board-wrapper`; sbWrapper.id = 'smart-board';
            
            if (displayGames.length > 0) {
                displayGames.forEach(g => {
                    const isDone = g.status === 'COMPLETED'; const isLive = (g.status === 'LIVE' || g.status === 'IN_PROGRESS');
                    const hName = getShortName(g.home_team.name); const aName = getShortName(g.away_team.name);
                    const hLogo = getLogo(g.home_team.name, g.home_team.meta?.logo); const aLogo = getLogo(g.away_team.name, g.away_team.meta?.logo);
                    const time = g.game_time ? g.game_time.slice(0, 5) : "";
                    let hScore = (isDone || isLive) ? (g.home_team.score ?? g.home_team.won_score ?? '-') : '-'; let aScore = (isDone || isLive) ? (g.away_team.score ?? g.away_team.won_score ?? '-') : '-';
                    const venueHtml = `<div class="venue-info" onclick="openMap('${g.venue}')"><i data-lucide="map-pin" width="12"></i> ${g.venue}</div>`;
                    let cardHtml = '';
                    if (isLive) {
                        let liveUrl = g.meta?.live_stream_url || `https://www.youtube.com/results?search_query=TPBL+${hName}+Live`;
                        cardHtml = `<div class="match-card" id="game-card-${g.id}" onclick="openGameDetails(${g.id})"><div class="match-status-bar">${venueHtml}<div class="match-info-group"><span class="badge live">LIVE</span></div></div><div class="match-content"><div class="team-col"><img src="${aLogo}" class="team-logo-lg"><div class="team-name">${aName}</div></div><div class="score-col"><div class="live-timer" id="live-timer-${g.id}">進行中</div><div class="score-val nums" id="live-score-${g.id}">${aScore} - ${hScore}</div><div class="card-period-box" id="live-periods-${g.id}"></div></div><div class="team-col"><img src="${hLogo}" class="team-logo-lg"><div class="team-name">${hName}</div></div></div><div class="match-actions"><div class="action-btn btn-live" onclick="event.stopPropagation(); window.open('${liveUrl}', '_blank')"><i data-lucide="tv" width="14"></i> 前往直播</div></div></div>`;
                    } else if (isDone) {
                        const hS = parseInt(hScore)||0; const aS = parseInt(aScore)||0; const aClass = (aS<hS)?'loser':''; const hClass = (hS<aS)?'loser':''; const aColor = (aS<hS)?'var(--text-sub)':'var(--tpbl-blue)'; const hColor = (hS<aS)?'var(--text-sub)':'var(--tpbl-blue)';
                        let recapUrl = g.meta?.recap || `https://www.youtube.com/results?search_query=TPBL+${hName}+vs+${aName}+Highlight`;
                        cardHtml = `<div class="match-card" id="game-card-${g.id}" onclick="openGameDetails(${g.id})"><div class="match-status-bar">${venueHtml}<div class="match-info-group"><span class="badge final">FINAL</span></div></div><div class="match-content"><div class="team-col ${aClass}"><img src="${aLogo}" class="team-logo-lg"><div class="team-name">${aName}</div></div><div class="score-col"><div class="score-val nums"><span style="color:${aColor}">${aScore}</span> <span style="color:#D1D1D6; font-weight:400">-</span> <span style="color:${hColor}">${hScore}</span></div></div><div class="team-col ${hClass}"><img src="${hLogo}" class="team-logo-lg"><div class="team-name">${hName}</div></div></div><div class="match-actions"><div class="action-btn btn-highlight" onclick="event.stopPropagation(); window.open('${recapUrl}', '_blank')"><i data-lucide="play-circle" width="14"></i> Watch Highlight</div></div></div>`;
                    } else {
                        const gameDateStr = g.game_date.split('-').slice(1).join('/'); const ticketUrl = getTicketLink(g.home_team.name);
                        cardHtml = `<div class="match-card" id="game-card-${g.id}"><div class="match-status-bar">${venueHtml}<div class="match-info-group"><span class="badge date">${gameDateStr}</span></div></div><div class="match-content"><div class="team-col"><img src="${aLogo}" class="team-logo-lg"><div class="team-name">${aName}</div></div><div class="score-col"><div class="game-time-big nums">${time}</div><div class="score-vs">VS</div></div><div class="team-col"><img src="${hLogo}" class="team-logo-lg"><div class="team-name">${hName}</div></div></div><div class="match-actions"><a href="${ticketUrl}" target="_blank" class="action-btn btn-ticket"><i data-lucide="ticket" width="14"></i> 購票資訊</a></div></div>`;
                    }
                    sbWrapper.innerHTML += cardHtml;
                });
                wrapper.appendChild(sbWrapper);
                if (displayGames.length > 1) {
                    const dotsContainer = document.createElement('div'); dotsContainer.className = 'carousel-dots';
                    for(let i=0; i<displayGames.length; i++) dotsContainer.innerHTML += `<div class="dot ${i===0?'active':''}" id="dot-${i}"></div>`;
                    wrapper.appendChild(dotsContainer);
                    setTimeout(() => { const board = document.getElementById('smart-board'); if (board) { board.addEventListener('scroll', () => { const index = Math.round(board.scrollLeft / board.offsetWidth); document.querySelectorAll('.dot').forEach(d => d.classList.remove('active')); const activeDot = document.getElementById(`dot-${index}`); if(activeDot) activeDot.classList.add('active'); }); } }, 500);
                }
            } else { sbWrapper.innerHTML = `<div style="padding:20px; width:100%; text-align:center; color:#999">本週無賽事</div>`; wrapper.appendChild(sbWrapper); }
            // --- 在 renderHome 內找到 MVP 渲染區塊 ---
                        if (globalMvpPosts && globalMvpPosts.length > 0) {
                            wrapper.innerHTML += `<div class="section-header" style="margin-top:24px;"><div class="section-title">本月 / 本週最佳球員</div><div class="section-date">MVP AWARDS</div></div>`;
                            
                            let wmvpHtml = `<div class="weekly-mvp-scroll">`;
                            globalMvpPosts.forEach(post => {
                                const t = post.title || "";
                                
                                // 同步過濾邏輯：只要有花體字、月字、或獎盃，就標記為 MONTHLY
                                const isMonthly = /[\u{1D400}-\u{1D7FF}]/u.test(t) || t.includes('月') || t.includes('🏆');
                                
                                const tagText = isMonthly ? 'MONTHLY MVP' : 'WEEKLY MVP';
                                const tagColor = isMonthly ? '#D4B07D' : '#FF3B30';
                                const tagIcon = isMonthly ? 'calendar' : 'zap';
                                const img = post.thumbnail || "";
                                const date = post.published_at ? post.published_at.split(' ')[0].replace(/-/g, '/') : '';
                                
                                wmvpHtml += `
                                    <div class="wmvp-post-card" onclick="window.open('https://tpbl.basketball/news/${post.id}', '_blank')">
                                        <img src="${img}" class="wmvp-post-img" loading="lazy" onerror="this.style.opacity='0'">
                                        <div class="wmvp-post-overlay">
                                            <div class="wmvp-post-tag" style="background:${tagColor}; color:#fff;">
                                                <i data-lucide="${tagIcon}" width="10"></i> ${tagText}
                                            </div>
                                            <div class="wmvp-post-title">${t}</div>
                                            <div class="wmvp-post-date nums">${date}</div>
                                        </div>
                                    </div>`;
                            });
                            wmvpHtml += `</div>`;
                            wrapper.innerHTML += wmvpHtml;
                        }

            // *** 注意：請記得刪除 renderHome 裡面原本渲染「本月最佳球員 (mvp-card)」的那段代碼，以免重複顯示 ***

       // --- 找到 renderHome 函數中 Standings 的區塊 ---
wrapper.innerHTML += `<div class="section-header" style="margin-top:20px;"><div class="section-title">聯盟戰績</div></div>`;

const sList = Array.isArray(globalStandings) ? globalStandings : (globalStandings.data || []);
let tbody = '';

sList.forEach((t, i) => {
    const rank = t.rank || (i + 1);
    const won = t.score_won_matches || 0;
    const lost = t.score_lost_matches || 0;
    
    // 計算勝率
    const pct = (won + lost) > 0 ? ((won / (won + lost)) * 100).toFixed(1) + '%' : '0.0%';
    
    // 直接抓取 API 提供的勝差與近況
    const gb = (t.games_behind === 0 || t.games_behind === "0") ? '-' : t.games_behind;
    const streak = t.streaks || '-';

    // 根據 W 或 L 設定近況顏色
    let streakColor = 'inherit';
    if (streak.startsWith('W')) streakColor = 'var(--live-red)';
    else if (streak.startsWith('L')) streakColor = 'var(--trend-down)';

    tbody += `
        <tr>
            <td style="font-weight:700; color:#888;" class="nums">${rank}</td>
            <td>
                <div class="st-team">
                    <img src="${getLogo(t.team.name, t.team.meta?.logo)}" style="width:20px;">
                    ${getShortName(t.team.name)}
                </div>
            </td>
            <td class="nums">${won}</td>
            <td class="nums">${lost}</td>
            <td class="nums" style="color:#666">${gb}</td>
            <td><span class="win-pct nums">${pct}</span></td>
            <td class="nums" style="font-weight:700; font-size:11px; color:${streakColor}">${streak}</td>
        </tr>`;
});

wrapper.innerHTML += `
    <div class="st-card">
        <table class="st-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>球隊</th>
                    <th>勝</th>
                    <th>敗</th>
                    <th>勝差</th>
                    <th>勝率</th>
                    <th>近況</th>
                </tr>
            </thead>
            <tbody>${tbody}</tbody>
        </table>
    </div>`;
            // --- Highlights Section (NEW) ---
            

            container.appendChild(wrapper);
            lucide.createIcons();
            if (scrollTargetId) setTimeout(() => { const target = document.getElementById(scrollTargetId); if(target) target.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' }); }, 300);
        }

        // New Helper Function for Highlights
        function renderHighlights(container) {
            const completed = globalGames.filter(g => g.status === 'COMPLETED').sort((a,b) => new Date(b.game_date) - new Date(a.game_date)).slice(0, 6);
            if(completed.length === 0) return;

            container.innerHTML += `<div class="section-header" style="margin-top:24px;"><div class="section-title">精選影音</div><div class="section-date">HIGHLIGHTS</div></div>`;
            const grid = document.createElement('div');
            grid.className = 'highlights-grid';
            
            completed.forEach(g => {
                const hName = getShortName(g.home_team.name);
                const aName = getShortName(g.away_team.name);
                const dateStr = g.game_date.split('-').slice(1).join('/');
                const title = `${aName} vs ${hName}`;
                
                let thumbUrl = "https://via.placeholder.com/320x180?text=TPBL";
                let linkUrl = g.meta?.recap || `https://www.youtube.com/results?search_query=TPBL+${hName}+vs+${aName}`;
                
                // Try to extract YouTube ID
                if (linkUrl.includes('youtube.com/watch?v=')) {
                    const vId = linkUrl.split('v=')[1].split('&')[0];
                    thumbUrl = `https://img.youtube.com/vi/${vId}/mqdefault.jpg`;
                } else if (linkUrl.includes('youtu.be/')) {
                    const vId = linkUrl.split('youtu.be/')[1].split('?')[0];
                    thumbUrl = `https://img.youtube.com/vi/${vId}/mqdefault.jpg`;
                } else {
                    // Fallback to match image if no direct video ID
                    thumbUrl = `https://via.placeholder.com/320x180/0F2848/FFFFFF?text=${aName}+vs+${hName}`;
                }

                grid.innerHTML += `
                    <a href="${linkUrl}" target="_blank" class="hl-card">
                        <div class="hl-img-box">
                            <img src="${thumbUrl}" class="hl-img" loading="lazy">
                            <div class="hl-play-icon"><i data-lucide="play" width="14" fill="white"></i></div>
                        </div>
                        <div class="hl-info">
                            <div class="hl-title">${title}</div>
                            <div class="hl-date nums"><i data-lucide="calendar" width="10"></i> ${dateStr}</div>
                        </div>
                    </a>
                `;
            });
            container.appendChild(grid);
        }

        function updateHomeUI() {
            const isHome = document.querySelector('.tab-bar .tab-btn:first-child').classList.contains('active'); if (!isHome) return;
            const liveGames = globalGames.filter(g => g.status === 'LIVE' || g.status === 'IN_PROGRESS'); const pulse = document.getElementById('live-pulse');
            if (liveGames.length > 0) { if(pulse) pulse.classList.add('active'); liveGames.forEach(g => { const scoreEl = document.getElementById(`live-score-${g.id}`); const timerEl = document.getElementById(`live-timer-${g.id}`); if (scoreEl) { const hS = g.home_team.score ?? g.home_team.won_score ?? '-'; const aS = g.away_team.score ?? g.away_team.won_score ?? '-'; const newScoreStr = `${aS} - ${hS}`; if (scoreEl.innerText !== newScoreStr) { scoreEl.innerText = newScoreStr; scoreEl.classList.add('updated'); setTimeout(() => scoreEl.classList.remove('updated'), 400); } } if (timerEl && g.game_clock) timerEl.innerText = g.game_clock; }); } else { if(pulse) pulse.classList.remove('active'); }
        }

        // --- Teams Render (OPTIMIZED & FIXED) ---
        function renderTeams() {
            const container = document.getElementById('app-container');
            const newContent = document.createElement('div'); newContent.className = 'container';
            newContent.innerHTML = `<div class="section-header"><div class="section-title">球隊專區</div><button onclick="openCompareModal()" class="action-btn" style="width:auto; padding:6px 12px; font-size:12px; background:#fff; border:1px solid #E5E5EA; color:var(--tpbl-blue);">⚔️ 球隊數據比較</button></div>`;

            if (!selectedStatsTeam) selectedStatsTeam = "攻城獅";

            // 1. Render Team Selector
            const selector = document.createElement('div'); selector.className = 'team-selector';
            KEYWORD_ORDER.forEach(keyword => {
                let logoUrl = LOGOS[keyword] || "https://via.placeholder.com/60";
                const isActive = (selectedStatsTeam && (selectedStatsTeam === keyword || selectedStatsTeam.includes(keyword)));
                if(isActive) selectedStatsTeam = keyword;
                selector.innerHTML += `<div class="ts-item ${isActive ? 'active' : ''}" onclick="selectTeam('${keyword}')"><div class="ts-ring"><img src="${logoUrl}" class="ts-logo"></div><div class="ts-name">${keyword}</div></div>`;
            });
            newContent.appendChild(selector);

            // 2. Prepare Data for Selected Team
            const currentKeyword = selectedStatsTeam;
            const statsKey = Object.keys(processedStats).find(name => name.includes(currentKeyword));
            const teamStats = statsKey ? processedStats[statsKey] : null;
            const fullTeamName = teamStats ? teamStats.name : currentKeyword;
            const teamColor = getTeamColor(fullTeamName);
            newContent.style.setProperty('--team-color', teamColor);

            // Get Standings Data
            const sList = Array.isArray(globalStandings) ? globalStandings : (globalStandings.data || []);
            let foundStand = null;
            try { foundStand = sList.find(s => s.team && s.team.name && s.team.name.includes(currentKeyword)); } catch(e) {}

            const leagueRank = foundStand ? foundStand.rank : '-';
            const wins = foundStand ? foundStand.score_won_matches : '-';
            const losses = foundStand ? foundStand.score_lost_matches : '-';
            const teamId = foundStand ? foundStand.team.id : null;
            
            // --- FIX: Force use local LOGOS map to prevent broken images ---
            const logo = LOGOS[currentKeyword] || (foundStand && foundStand.team.meta ? foundStand.team.meta.logo : "https://via.placeholder.com/60");

            // 3. Render Header Card
            newContent.innerHTML += `
                <div class="team-dashboard">
                    <div class="td-header-card">
                        <img src="${logo}" class="td-header-bg-icon">
                        <div class="td-info-col">
                            <div class="td-name-lg">${currentKeyword}</div>
                            <div class="td-record"><span class="td-rank-badge">排名 #${leagueRank}</span><span>${wins} 勝 - ${losses} 敗</span></div>
                        </div>
                        <img src="${logo}" style="width:60px; height:60px; z-index:2; filter:drop-shadow(0 4px 6px rgba(0,0,0,0.1));">
                    </div>
                </div>
                
                <!-- NEW: Banner Container (Placed between Info Card and Stats) -->
                <div id="team-banner-container" class="team-dashboard"></div>
            `;
            
            // Load Banner immediately if Team ID exists
            if (teamId) { loadTeamBanner(teamId); }

            // 4. Render Stats
            if (teamStats && teamStats.stats.length > 0) {
                const statsContainer = document.createElement('div'); statsContainer.className = 'stats-grid-container team-dashboard';
                teamStats.stats.forEach(stat => {
                    let displayVal = stat.isPct ? (stat.value * 100).toFixed(1) + '%' : (Number.isInteger(stat.value) ? stat.value : stat.value.toFixed(1));
                    statsContainer.innerHTML += `<div class="stat-box"><div class="sb-top"><div class="sb-label"><i data-lucide="${stat.icon}" width="12" style="color:#aaa"></i> ${stat.label}</div><span class="rank-tag ${stat.rank === 1 ? 'top-1' : ''}">#${stat.rank}</span></div><div class="sb-value nums">${displayVal}</div></div>`;
                });
                newContent.appendChild(statsContainer);
            } else {
                 newContent.innerHTML += `<div class="section-divider">團隊數據</div><div style="text-align:center; padding:20px; color:#aaa; font-size:12px; background:#fff; border-radius:12px; margin-bottom:16px;">目前無法取得團隊攻守數據</div>`;
            }

            // 5. Render Roster
            newContent.innerHTML += `<div class="section-header"><div class="section-title">球員名單</div></div>`;
            const rosterGrid = document.createElement('div'); rosterGrid.className = 'roster-grid team-dashboard';
            const teamPlayers = globalPlayers.filter(p => p.team && p.team.name && p.team.name.includes(currentKeyword)).sort((a,b) => parseInt(a.number) - parseInt(b.number));
            
            if (teamPlayers.length > 0) {
                teamPlayers.forEach(p => {
                    let img = ""; let imgStyle = "";
                    if(p.images && p.images.length > 0) {
                        const lg = p.images.find(i => i.key === 'xl') || p.images.find(i => i.key === 'lg');
                        if(lg) img = lg.url;
                    }
                    if (!img) { img = DEFAULT_AVATAR; imgStyle = `background-color: ${teamColor}; padding-bottom: 0;`; }
                    rosterGrid.innerHTML += `<div class="roster-card" onclick="openPlayerProfile(${p.id})"><div class="rc-num">#${p.number}</div><div class="rc-img-box" style="${imgStyle}"><img src="${img}" class="rc-img" loading="lazy"></div><div class="rc-name">${p.name}</div><div class="rc-pos">${formatPos(p.meta.position)}</div><div class="rc-meta nums">${p.meta.height||'-'}cm</div></div>`;
                });
            } else { rosterGrid.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#999; padding:20px;">暫無球員資料</div>`; }
            newContent.appendChild(rosterGrid);

            container.innerHTML = ''; container.appendChild(newContent); lucide.createIcons();
            const activeItem = document.querySelector('.ts-item.active'); if (activeItem) activeItem.scrollIntoView({ behavior: 'auto', block: 'nearest', inline: 'center' });
        }
        
        window.selectTeam = function(teamName) { selectedStatsTeam = teamName; renderTeams(); }

        // --- NEW BANNER FETCH FUNCTION ---
        async function loadTeamBanner(teamId) {
            try {
                // Fetch banner from API
                const res = await fetchJson(`https://api.tpbl.basketball/api/teams/${teamId}/banners`);
                const data = res.data || res; // Handle different JSON structures
                const banners = data.result || data; // Often wrapped in "result"

                if(banners && banners.length > 0) {
                    // Get the first banner
                    const b = banners[0];
                    // Prefer mobile_image, fallback to image
                    const imgUrl = b.mobile_image || b.image;
                    
                    const container = document.getElementById('team-banner-container');
                    if(container && imgUrl) {
                        // Using the new CSS class for consistent styling
                        container.innerHTML = `<img src="${imgUrl}" class="team-banner-img" loading="lazy">`;
                    }
                }
            } catch(e) {
                console.warn("Failed to load banner for team " + teamId, e);
            }
        }

        // --- Compare Page ---
        function openCompareModal() {
            toggleBodyLock(true); const page = document.getElementById('compare-page'); page.classList.add('active');
            if (!compareTeamA && KEYWORD_ORDER.length > 0) { const fullA = Object.keys(processedStats).find(n => n.includes(KEYWORD_ORDER[0])); if (fullA) compareTeamA = fullA; }
            if (!compareTeamB && KEYWORD_ORDER.length > 1) { const fullB = Object.keys(processedStats).find(n => n.includes(KEYWORD_ORDER[1])); if (fullB) compareTeamB = fullB; }
            renderComparePage();
        }
        function closeCompareModal() { toggleBodyLock(false); const page = document.getElementById('compare-page'); page.classList.remove('active'); setTimeout(() => { page.style.transform = ''; }, 350); }
        function renderComparePage() {
            const body = document.getElementById('compare-body'); let optionsHtml = ''; KEYWORD_ORDER.forEach(k => { const fullName = Object.keys(processedStats).find(n => n.includes(k)); if(fullName) optionsHtml += `<option value="${fullName}">${k}</option>`; });
            const selA = `<select id="sel-team-a" class="cs-select" onchange="updateCompareTeam('A', this.value)">${optionsHtml}</select>`;
            const selB = `<select id="sel-team-b" class="cs-select" onchange="updateCompareTeam('B', this.value)">${optionsHtml}</select>`;
            let content = `<div class="compare-selectors"><div class="cs-col"><div class="cs-label">TEAM A</div>${selA}</div><div class="cs-col"><div class="cs-label">TEAM B</div>${selB}</div></div>`;
            if (compareTeamA && compareTeamB && processedStats[compareTeamA] && processedStats[compareTeamB]) { content += renderSeasonComparison(processedStats[compareTeamA], processedStats[compareTeamB]); content += renderHeadToHeadHistory(compareTeamA, compareTeamB); } else { content += `<div class="loading">請選擇球隊以進行比較</div>`; }
            body.innerHTML = content; if(compareTeamA) document.getElementById('sel-team-a').value = compareTeamA; if(compareTeamB) document.getElementById('sel-team-b').value = compareTeamB; lucide.createIcons();
        }
        window.updateCompareTeam = function(side, value) { if (side === 'A') compareTeamA = value; else compareTeamB = value; renderComparePage(); }
        function renderSeasonComparison(statsA, statsB) {
            const getVal = (statsObj, labelKey) => { const found = statsObj.stats.find(s => s.label === labelKey); return found ? found.value : 0; };
            const metrics = [ { label: '場均得分', key: '場均得分', isPct: false }, { label: '場均籃板', key: '場均籃板', isPct: false }, { label: '場均助攻', key: '場均助攻', isPct: false }, { label: '場均抄截', key: '場均抄截', isPct: false }, { label: '場均阻攻', key: '場均阻攻', isPct: false }, { label: '投籃命中率', key: '投籃%', isPct: true, multi: 100 }, { label: '三分命中率', key: '三分%', isPct: true, multi: 100 }, { label: '罰球命中率', key: '罰球%', isPct: true, multi: 100 }, { label: '場均失分', key: '場均失分', isPct: false, invert: true } ];
            let rowsHtml = ''; metrics.forEach(m => { let valA = getVal(statsA, m.key); let valB = getVal(statsB, m.key); let dispA = m.isPct ? (valA * 100).toFixed(1) + '%' : valA.toFixed(1); let dispB = m.isPct ? (valB * 100).toFixed(1) + '%' : valB.toFixed(1); let maxVal = Math.max(valA, valB); if (maxVal === 0) maxVal = 1; let perA = (valA / maxVal) * 100; let perB = (valB / maxVal) * 100; let isAWin = m.invert ? (valA < valB) : (valA > valB); let isBWin = m.invert ? (valB < valA) : (valB > valA); if (valA === valB) { isAWin = false; isBWin = false; } rowsHtml += `<div class="comp-row"><div class="comp-side left"><div class="comp-wrapper"><div class="comp-val nums">${dispA}</div><div class="comp-bar-bg"><div class="comp-bar left ${isAWin ? 'winner' : ''}" style="width: ${perA}%"></div></div></div></div><div class="comp-label">${m.label}</div><div class="comp-side right"><div class="comp-wrapper"><div class="comp-bar-bg"><div class="comp-bar right ${isBWin ? 'winner' : ''}" style="width: ${perB}%"></div></div><div class="comp-val nums">${dispB}</div></div></div></div>`; });
            const shortA = getShortName(statsA.name); const shortB = getShortName(statsB.name); const logoA = getLogo(statsA.name, statsA.logo); const logoB = getLogo(statsB.name, statsB.logo);
            return `<div class="comparison-card" style="margin-top:0"><div class="comp-title" style="justify-content:center; gap:20px; font-size:16px;"><div style="display:flex; flex-direction:column; align-items:center;"><img src="${logoA}" width="40"><span style="font-size:12px; margin-top:4px;">${shortA}</span></div><div style="font-style:italic; color:#D4B07D; font-weight:800;">VS</div><div style="display:flex; flex-direction:column; align-items:center;"><img src="${logoB}" width="40"><span style="font-size:12px; margin-top:4px;">${shortB}</span></div></div><div style="height:1px; background:#f0f0f0; margin:12px 0;"></div>${rowsHtml}</div>`;
        }
        function renderHeadToHeadHistory(nameA, nameB) {
            const matches = globalGames.filter(g => { const h = g.home_team.name; const a = g.away_team.name; const validStatus = g.status === 'COMPLETED'; const isMatch = (h === nameA && a === nameB) || (h === nameB && a === nameA); return validStatus && isMatch; }).sort((a, b) => new Date(b.game_date) - new Date(a.game_date));
            if (matches.length > 0) { let rows = ''; matches.forEach(g => { const dateStr = g.game_date.split('-').slice(1).join('/'); const isAHome = g.home_team.name === nameA; const scoreA = parseInt(isAHome ? (g.home_team.score||g.home_team.won_score||0) : (g.away_team.score||g.away_team.won_score||0)); const scoreB = parseInt(!isAHome ? (g.home_team.score||g.home_team.won_score||0) : (g.away_team.score||g.away_team.won_score||0)); const logoA = getLogo(nameA, isAHome ? g.home_team.meta?.logo : g.away_team.meta?.logo); const logoB = getLogo(nameB, !isAHome ? g.home_team.meta?.logo : g.away_team.meta?.logo); const shortA = getShortName(nameA); const shortB = getShortName(nameB); const classA = scoreA > scoreB ? 'color:var(--tpbl-blue); font-weight:800;' : 'color:#8E8E93;'; const classB = scoreB > scoreA ? 'color:var(--tpbl-blue); font-weight:800;' : 'color:#8E8E93;'; const logoStyleA = scoreA < scoreB ? 'opacity:0.6; filter:grayscale(1);' : ''; const logoStyleB = scoreB < scoreA ? 'opacity:0.6; filter:grayscale(1);' : ''; const indA = isAHome ? '<i data-lucide="home" width="10"></i>' : '<i data-lucide="plane" width="10"></i>'; const indB = !isAHome ? '<i data-lucide="home" width="10"></i>' : '<i data-lucide="plane" width="10"></i>'; rows += `<tr><td style="color:#8E8E93; font-weight:500; font-family:'SF Mono', monospace;">${dateStr}</td><td style="text-align:right;"><div style="display:flex; align-items:center; justify-content:flex-end; gap:4px; ${classA}"><span style="font-size:9px;opacity:0.6;display:flex;align-items:center;">${indA}</span>${shortA} <img src="${logoA}" style="width:24px; height:24px; object-fit:contain; ${logoStyleA}"></div></td><td style="font-family:'SF Mono', monospace; font-weight:700; font-size:14px; white-space:nowrap;"><span style="${classA}">${scoreA}</span> : <span style="${classB}">${scoreB}</span></td><td style="text-align:left;"><div style="display:flex; align-items:center; justify-content:flex-start; gap:4px; ${classB}"><img src="${logoB}" style="width:24px; height:24px; object-fit:contain; ${logoStyleB}"> ${shortB}<span style="font-size:9px;opacity:0.6;display:flex;align-items:center;">${indB}</span></div></td></tr>`; }); return `<div class="section-divider" style="margin-top:24px;"><i data-lucide="history" width="14"></i><span>本季對戰紀錄 (${matches.length}場)</span></div><div class="st-card" style="box-shadow: 0 4px 12px rgba(0,0,0,0.05);"><table class="recent-games-table" style="margin-bottom:0;"><thead><tr><th style="width:15%">日期</th><th style="width:35%; text-align:right; padding-right:34px;">TEAM A</th><th style="width:15%">比分</th><th style="width:35%; text-align:left; padding-left:34px;">TEAM B</th></tr></thead><tbody>${rows}</tbody></table></div>`; } else { return `<div class="section-divider" style="margin-top:24px;"><i data-lucide="history" width="14"></i><span>本季對戰紀錄</span></div><div style="text-align:center; padding:30px; color:#aaa; background:#fff; border-radius:12px; font-size:12px;">本季尚未交手</div>`; }
        }

        // --- Schedule Render & Prediction ---
        // --- 修改後的 renderSchedule 函數 ---
        // --- 修改後的 renderSchedule 函數 ---
        function renderSchedule() {
            const container = document.getElementById('app-container');
            container.innerHTML = '';
            const wrapper = document.createElement('div');
            wrapper.className = 'container';
            
            // 渲染上方分段控制器
            wrapper.innerHTML += `
                <div class="seg-control">
                    <button class="seg-btn ${currentScheduleTab === 'future' ? 'active' : ''}" onclick="switchScheduleTab('future')">未來賽事</button>
                    <button class="seg-btn ${currentScheduleTab === 'completed' ? 'active' : ''}" onclick="switchScheduleTab('completed')">已完賽</button>
                </div>`;

            

            let list = (currentScheduleTab === 'completed')
                ? globalGames.filter(g => g.status === 'COMPLETED').sort((a, b) => new Date(b.game_date) - new Date(a.game_date))
                : globalGames.filter(g => g.status !== 'COMPLETED').sort((a, b) => new Date(a.game_date) - new Date(b.game_date));

            if(list.length === 0) {
                wrapper.innerHTML += `<div class="loading">無相關賽事</div>`;
            } else {
                const listContainer = document.createElement('div');
                listContainer.className = 'sch-container';
                
                if (currentScheduleTab === 'completed') {
                    wrapper.innerHTML += `<div class="section-header"><div class="section-title">歷史賽報</div></div>`;
                }

                list.forEach(g => {
                    const dateObj = new Date(g.game_date);
                    const monthStr = dateObj.toLocaleString('en-US', { month: 'short' }).toUpperCase();
                    const dayStr = dateObj.getDate();
                    const time = g.game_time ? g.game_time.slice(0, 5) : 'TBD';
                    const isDone = g.status === 'COMPLETED';
                    const isLive = g.status === 'LIVE' || g.status === 'IN_PROGRESS';
                    
                    const hScore = (isDone || isLive) ? (g.home_team.score ?? g.home_team.won_score ?? 0) : '-';
                    const aScore = (isDone || isLive) ? (g.away_team.score ?? g.away_team.won_score ?? 0) : '-';
                    
                    const hWin = parseInt(hScore) > parseInt(aScore);
                    const aWin = parseInt(aScore) > parseInt(hScore);
                    const hClass = (isDone && !hWin) ? 'lose' : (isDone && hWin ? 'win' : '');
                    const aClass = (isDone && !aWin) ? 'lose' : (isDone && aWin ? 'win' : '');
                    
                    const hName = getShortName(g.home_team.name);
                    const aName = getShortName(g.away_team.name);
                    
                    let actionHtml = '';
                    
                    if (isLive) {
                        actionHtml = `<div class="sch-btn live"><i data-lucide="tv" width="10"></i> 進行中</div>`;
                    } else if (isDone) {
                        // --- 這裡修改：加入「全場精華」按鈕 ---
                        const recapUrl = g.meta?.recap || `https://www.youtube.com/results?search_query=TPBL+${hName}+vs+${aName}+Highlight`;
                        actionHtml = `
                            <div style="display:flex; gap:8px;">
                                <div class="sch-btn stats">
                                    數據 <i data-lucide="chevron-right" width="10"></i>
                                </div>
                                <div class="sch-btn" style="background:var(--tpbl-blue); color:white; border:none;" onclick="event.stopPropagation(); window.open('${recapUrl}', '_blank')">
                                    <i data-lucide="play-circle" width="12"></i> 全場精華
                                </div>
                            </div>`;
                    } else {
                        const ticketUrl = getTicketLink(g.home_team.name);
                        actionHtml = `
                            <div style="display:flex; gap:8px; align-items:center; width:100%; justify-content:flex-end;">
                                <button class="sch-btn predict" onclick="event.stopPropagation(); openAiModal(${g.id}, '${g.home_team.name}', '${g.away_team.name}')">
                                    <i data-lucide="sparkles" width="12"></i> AI 預測
                                </button>
                                <div class="sch-btn ticket" onclick="event.stopPropagation(); window.open('${ticketUrl}', '_blank')">
                                    <i data-lucide="ticket" width="10"></i> 購票
                                </div>
                            </div>`;
                    }
                    
                    const cardClickAttr = (isLive || isDone) ? `onclick="openGameDetails(${g.id})"` : '';
                    const cardHtml = `
                        <div class="sch-card" ${cardClickAttr}>
                            <div class="sch-card-main">
                                <div class="sch-date-col">
                                    <span class="sch-date-main nums">${dayStr}</span>
                                    <span class="sch-date-sub">${monthStr}</span>
                                    <div class="sch-time nums">${time}</div>
                                </div>
                                <div class="sch-matchup">
                                    <div class="sch-team-row">
                                        <div class="sch-team-info">
                                            <img src="${getLogo(g.away_team.name, g.away_team.meta?.logo)}" class="sch-team-logo">
                                            <span class="sch-team-name ${aClass}">${aName}</span>
                                        </div>
                                        <div class="sch-team-score ${aClass} nums">${aScore}</div>
                                    </div>
                                    <div style="height:1px; background:#f5f5f7; margin:2px 0;"></div>
                                    <div class="sch-team-row">
                                        <div class="sch-team-info">
                                            <img src="${getLogo(g.home_team.name, g.home_team.meta?.logo)}" class="sch-team-logo">
                                            <span class="sch-team-name ${hClass}">${hName}</span>
                                        </div>
                                        <div class="sch-team-score ${hClass} nums">${hScore}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="sch-card-footer">
                                <div class="sch-venue" onclick="openMap('${g.venue}')">
                                    <i data-lucide="map-pin" width="12"></i> ${g.venue.split(' ')[0]}
                                </div>
                                <div class="sch-actions" style="flex:1; justify-content:flex-end; display:flex;">
                                    ${actionHtml}
                                </div>
                            </div>
                        </div>`;
                    listContainer.innerHTML += cardHtml;
                });
                wrapper.appendChild(listContainer);
            }
            container.appendChild(wrapper);
            lucide.createIcons();
        }

        function openAiModal(gameId, hFullName, aFullName) {
            const modal = document.getElementById('ai-modal'); const body = document.getElementById('ai-modal-body'); modal.classList.add('active'); toggleBodyLock(true);
            body.innerHTML = `<div style="padding:40px 0;"><div class="ai-loading-icon"><i data-lucide="cpu" width="48" height="48"></i></div><div style="font-weight:700; color:var(--tpbl-blue);">AI 分析中...</div><div style="font-size:12px; color:#888; margin-top:8px;">正在計算進攻效率與防守強度</div></div>`; lucide.createIcons();
            
            setTimeout(() => {
                const sList = Array.isArray(globalStandings) ? globalStandings : (globalStandings.data || []);
                const getWinPct = (name) => { const t = sList.find(s => s.team.name === name); if(!t) return 0.5; const total = t.score_won_matches + t.score_lost_matches; return total > 0 ? (t.score_won_matches / total) : 0.5; };
                const hPct = getWinPct(hFullName); const aPct = getWinPct(aFullName);
                const homeAdvantage = 0.08;
                const randomFactor = (Math.random() * 0.15) - 0.075;
                
                let homeProb = 0.5 + ((hPct - aPct) / 1.5) + homeAdvantage + randomFactor;
                if (homeProb > 0.92) homeProb = 0.92; if (homeProb < 0.08) homeProb = 0.08;
                
                const isHomeWin = homeProb >= 0.5;
                const winnerName = isHomeWin ? getShortName(hFullName) : getShortName(aFullName);
                const winProb = isHomeWin ? homeProb : (1 - homeProb);
                const percentage = Math.round(winProb * 100);
                
                // Enhanced Predictions
                // 1. Point Spread
                const spreadBase = Math.abs(hPct - aPct) * 20;
                let estimatedSpread = Math.max(2.5, Math.round(spreadBase + (Math.random() * 5)));
                if(estimatedSpread > 15) estimatedSpread = 15.5; // Cap spread
                
                // 2. Total Score (Over/Under)
                const totalScore = 185 + Math.floor(Math.random() * 25);
                
                // 3. Key Factor
                const factors = [
                    "禁區籃板保護", "外線命中率", "轉換快攻得分", "替補陣容深度",
                    "關鍵球處理能力", "罰球穩定性", "團隊助攻效率", "控制失誤次數"
                ];
                const keyFactor = factors[Math.floor(Math.random() * factors.length)];
                
                body.innerHTML = `
                    <div style="animation:fadeIn 0.5s ease">
                        <div class="ai-result-title">AI PREDICTION</div>
                        <div class="ai-winner-name">${winnerName}</div>
                        <div class="ai-win-prob nums">${percentage}% <span style="font-size:14px;color:#888;">勝率</span></div>
                        
                        <div style="display:flex; gap:8px; margin-bottom:12px;">
                            <div style="flex:1; background:#f9f9f9; padding:10px; border-radius:10px; border:1px solid #eee;">
                                <div style="font-size:10px; color:#888; font-weight:700;">預測勝分</div>
                                <div style="font-size:16px; font-weight:800; color:var(--text-main); font-family:'SF Mono'">${estimatedSpread}</div>
                            </div>
                            <div style="flex:1; background:#f9f9f9; padding:10px; border-radius:10px; border:1px solid #eee;">
                                <div style="font-size:10px; color:#888; font-weight:700;">大小分</div>
                                <div style="font-size:16px; font-weight:800; color:var(--text-main); font-family:'SF Mono'">${totalScore}.5</div>
                            </div>
                        </div>
                        
                        <div class="ai-analysis-box">
                            <div class="ai-ab-title"><i data-lucide="search" width="12"></i> 獲勝關鍵</div>
                            <div class="ai-ab-text">本場比賽的關鍵在於 <span style="color:#0F2848; font-weight:800;">${keyFactor}</span>，若能在此環節取得優勢，${winnerName} 將有極大機會拿下勝利。</div>
                        </div>
                    </div>`;
                lucide.createIcons();
            }, 1500);
        }
        function closeAiModal() { const modal = document.getElementById('ai-modal'); modal.classList.remove('active'); toggleBodyLock(false); }

        // --- SWIPE UTILS & PAGE LOGIC ---
        let savedScrollPosition = 0;
        function toggleBodyLock(isLocked) { if (isLocked) { savedScrollPosition = window.scrollY; document.body.style.top = `-${savedScrollPosition}px`; document.body.classList.add('modal-open'); } else { document.body.classList.remove('modal-open'); document.body.style.top = ''; window.scrollTo(0, savedScrollPosition); } }
        function initSwipeGesture(element, closeCallback) { let startX = 0; let currentX = 0; let isDragging = false; element.addEventListener('touchstart', (e) => { if (e.touches[0].clientX < 40) { startX = e.touches[0].clientX; isDragging = true; element.style.transition = 'none'; } else { isDragging = false; } }, {passive: true}); element.addEventListener('touchmove', (e) => { if (!isDragging) return; currentX = e.touches[0].clientX; const diff = currentX - startX; if (diff > 0) element.style.transform = `translateX(${diff}px)`; }, {passive: true}); element.addEventListener('touchend', (e) => { if (!isDragging) return; isDragging = false; element.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)'; if ((currentX - startX) > 100) { closeCallback(); setTimeout(() => { element.style.transform = ''; }, 300); } else { element.style.transform = ''; } }); }
        function closeGameModal() { toggleBodyLock(false); document.getElementById('game-page').classList.remove('active'); currentDetailedGameData = null; setTimeout(() => { document.getElementById('game-page').style.transform = ''; }, 350); }
        function closePlayerModal() {
            toggleBodyLock(false);
            document.getElementById('player-page').classList.remove('active');
            // Destroy chart instance to prevent memory leaks or reuse issues
            if(window.myRadarChart) { window.myRadarChart.destroy(); window.myRadarChart = null; }
            setTimeout(() => { document.getElementById('player-page').style.transform = ''; }, 350);
        }
        
        // --- NEW: Percent calculation helper ---
        function calculatePct(statStr) {
            if (!statStr || !statStr.includes('-')) return '-';
            const [m, a] = statStr.split('-').map(Number);
            if (a === 0 || isNaN(a)) return '0%';
            return ((m / a) * 100).toFixed(1) + '%';
        }

        async function openGameDetails(gameId) {
            toggleBodyLock(true);
            const page = document.getElementById('game-page');
            const body = document.getElementById('modal-body');
            page.classList.add('active');
            body.innerHTML = '<div class="loading">載入比賽數據...</div>';
            
            try {
                const ts = Date.now();
                const json = await fetchJson(`https://api.tpbl.basketball/api/games/${gameId}/stats?t=${ts}`);
                const data = json.data || json;
                currentDetailedGameData = data;
                
                const gameInfo = globalGames.find(g => g.id === gameId);
                if (!gameInfo) throw new Error("找不到賽事資訊");

                const hName = getShortName(gameInfo.home_team.name);
                const aName = getShortName(gameInfo.away_team.name);
                const hLogo = getLogo(hName, gameInfo.home_team.meta?.logo);
                const aLogo = getLogo(aName, gameInfo.away_team.meta?.logo);
                
                const hScore = data.home_team.score ?? (data.home_team.teams?.total?.won_score) ?? '-';
                const aScore = data.away_team.score ?? (data.away_team.teams?.total?.won_score) ?? '-';
                
                // 1. 比分卡
                let content = `<div class="modal-score-card">
                    <div class="msc-main">
                        <div style="text-align:center"><img src="${aLogo}" style="width:40px"><div style="font-size:12px;font-weight:700;margin-top:4px">${aName}</div></div>
                        <div class="m-score nums">${aScore} - ${hScore}</div>
                        <div style="text-align:center"><img src="${hLogo}" style="width:40px"><div style="font-size:12px;font-weight:700;margin-top:4px">${hName}</div></div>
                    </div>
                    ${renderPeriodTable(data, hName, aName)}
                </div>`;
                
                // 2. 插入兩隊得分王 (得分/籃板/助攻)
                content += renderGameBestPlayers(data);

                // 3. 節次得分與團隊對比
                if (data.home_team.teams && data.home_team.teams.rounds) content += renderGameFlowTable(data.home_team.teams.rounds, data.away_team.teams.rounds, hName, aName);
                if (data.home_team.teams && data.home_team.teams.total) content += renderTeamComparison(data.home_team.teams.total, data.away_team.teams.total);
                
                // 4. 詳細 Boxscore
                if (data.home_team && data.home_team.players) {
                    const hp = data.home_team.players.total || data.home_team.players;
                    const ap = data.away_team.players.total || data.away_team.players;
                    const ht = data.home_team.teams?.total || null;
                    const at = data.away_team.teams?.total || null;

                    content += `<div class="section-divider" style="margin-top:20px;">詳細數據</div>
                        <div class="modal-tabs">
                            <button class="modal-tab-btn active" onclick="switchModalTab('away')">${aName}</button>
                            <button class="modal-tab-btn" onclick="switchModalTab('home')">${hName}</button>
                        </div>
                        <div id="tab-away" class="tab-content">${renderTeamBoxScore(ap, aName, at)}</div>
                        <div id="tab-home" class="tab-content hidden">${renderTeamBoxScore(hp, hName, ht)}</div>`;
                }
                
                body.innerHTML = content;
                lucide.createIcons();
            } catch (e) {
                console.error(e);
                body.innerHTML = `<div class="error-msg">數據加載失敗</div>`;
            }
        }
        
        // --- NEW: Quarter Switching Logic ---
        window.switchBoxScorePeriod = function(period) {
            if (!currentDetailedGameData) return;
            const data = currentDetailedGameData;
            
            document.querySelectorAll('#bs-period-switcher .seg-btn').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector(`#bs-period-switcher .seg-btn[onclick*="${period}"]`);
            if(btn) btn.classList.add('active');

            const hName = getShortName(data.home_team.name);
            const aName = getShortName(data.away_team.name);
            
            // Re-render sub-tabs
            const awayNode = data.away_team.players[period] || [];
            const homeNode = data.home_team.players[period] || [];
            const awayTeamNode = data.away_team.teams[period] || null;
            const homeTeamNode = data.home_team.teams[period] || null;

            document.getElementById('tab-away').innerHTML = renderTeamBoxScore(awayNode, aName, awayTeamNode);
            document.getElementById('tab-home').innerHTML = renderTeamBoxScore(homeNode, hName, homeTeamNode);
            lucide.createIcons();
        }
        // 修正對手判斷邏輯：確保顯示的是「非自己」的隊伍
        function getOpponentInfo(game, myTeamName) {
            if (!game) return { name: "對手", logo: "https://via.placeholder.com/30" };
            // 如果主隊名稱包含球員隊名，對手就是客隊
            const isHome = game.home_team.name.includes(myTeamName);
            const opp = isHome ? game.away_team : game.home_team;
            return {
                name: getShortName(opp.name),
                logo: getLogo(opp.name, opp.meta?.logo)
            };
        }

        async function openPlayerProfile(playerId) {
            toggleBodyLock(true);
            const page = document.getElementById('player-page');
            const body = document.getElementById('player-modal-body');
            page.classList.add('active');
            body.innerHTML = '<div class="loading">正在生成球員檔案...</div>';

            const pBasic = globalPlayers.find(p => p.id === playerId);

            try {
                const ts = Date.now();
                const [s2Res, s1Res] = await Promise.all([
                    fetchJson(`https://api.tpbl.basketball/api/players/${playerId}/games/stats?division_id=9&t=${ts}`),
                    fetchJson(`https://api.tpbl.basketball/api/players/${playerId}/games/stats?division_id=2&t=${ts}`)
                ]);

                const s2Logs = Array.isArray(s2Res) ? s2Res : (s2Res.data || []);
                const s1Logs = Array.isArray(s1Res) ? s1Res : (s1Res.data || []);
                
                const calcStats = (logs) => {
                    let s = { gp: 0, min: 0, pts: 0, reb: 0, ast: 0, stl: 0, blk: 0 };
                    logs.filter(l => l.accumulated_stats?.time_on_court > 0).forEach(l => {
                        const acc = l.accumulated_stats;
                        s.gp++; s.min += acc.time_on_court; s.pts += acc.score;
                        s.reb += acc.rebounds; s.ast += acc.assists;
                        s.stl += acc.steals; s.blk += acc.blocks;
                    });
                    if (s.gp === 0) return null;
                    const f = (v) => (v / s.gp).toFixed(1);
                    return {
                        gp: s.gp, pts: f(s.pts), reb: f(s.reb), ast: f(s.ast), stl: f(s.stl), blk: f(s.blk),
                        raw: { pts: s.pts/s.gp, reb: s.reb/s.gp, ast: s.ast/s.gp, stl: s.stl/s.gp, blk: s.blk/s.gp }
                    };
                };

                const avg2 = calcStats(s2Logs);
                const avg1 = calcStats(s1Logs);

                const teamName = pBasic ? pBasic.team.name : (s2Logs[0]?.team.name || '');
                const teamColor = getTeamColor(teamName);
                const isFav = favoritePlayerIds.includes(playerId);
                let imgUrl = pBasic?.images?.find(i => i.key === 'lg')?.url || playerMap[pBasic?.name.replace(/\s/g, '')] || DEFAULT_AVATAR;

                // --- 1. 沉浸式 Header (修正數據歪斜與語法錯誤版) ---
                // ... 之前的程式碼
                // --- 1. 沉浸式 Header (修正對齊與收藏按鈕版) ---
                let headerHtml = `
                    <div class="immersive-header">
                        <div class="immersive-banner" style="background: linear-gradient(180deg, ${teamColor} 0%, ${hexToRgba(teamColor, 0.85)} 100%)">
                            <!-- 背景浮水印 -->
                            <img src="${getLogo(teamName)}" class="imm-watermark">
                            
                            <!-- 內容橫條：頭像、文字、按鈕都在這一行 -->
                            <div class="imm-info-content">
                                <div class="imm-avatar-box">
                                    <img src="${imgUrl}" class="imm-avatar-img">
                                </div>
                                <div class="imm-text-box">
                                    <div class="imm-p-name">${pBasic?.name || '未知球員'}</div>
                                    <div class="imm-p-sub">${getShortName(teamName)} · #${pBasic?.number || '00'} · ${formatPos(pBasic?.meta?.position)}</div>
                                </div>
                                
                                <!-- 收藏按鈕：高度會與頭像一致 -->
                                <button id="fav-btn-${playerId}" 
                                        class="pch-fav-btn ${isFav ? 'active' : ''}" 
                                        style="--team-accent: ${teamColor};" 
                                        onclick="toggleFavorite(${playerId})">
                                    <i data-lucide="star" ${isFav ? 'fill="currentColor"' : ''} width="22"></i>
                                </button>
                            </div>
                        </div>

                        <!-- 核心數據橫條卡片 (浮動在紫色背景邊緣) -->
                        <div class="floating-stats-card nums">
                            <div class="f-stat-item">
                                <span class="f-stat-val">${avg2 ? avg2.pts : '-'}</span>
                                <span class="f-stat-lbl">得分</span>
                            </div>
                            <div class="f-stat-divider"></div>
                            <div class="f-stat-item">
                                <span class="f-stat-val">${avg2 ? avg2.reb : '-'}</span>
                                <span class="f-stat-lbl">籃板</span>
                            </div>
                            <div class="f-stat-divider"></div>
                            <div class="f-stat-item">
                                <span class="f-stat-val">${avg2 ? avg2.ast : '-'}</span>
                                <span class="f-stat-lbl">助攻</span>
                            </div>
                        </div>
                    </div>
                

                    <style>
                        #player-modal-body { padding-top: 0; overflow-x: hidden; }
                        
                        /* 整個 Header 容器 */
                        .immersive-header { 
                            margin: 0 calc(var(--page-padding) * -1) 24px calc(var(--page-padding) * -1); 
                            position: relative; 
                            width: calc(100% + (var(--page-padding) * 2));
                        }

                        /* 紫色漸層背景區 */
                        .immersive-banner { 
                            height: 180px; /* 稍微縮短高度讓比例更好看 */
                            width: 100%; 
                            position: relative; 
                            padding: 0 var(--page-padding); 
                            display: flex; 
                            align-items: center; /* 讓內容垂直居中 */
                            overflow: hidden; 
                            box-sizing: border-box;
                        }

                        /* 內容橫向佈局 */
                        .imm-info-content { 
                            display: flex; 
                            align-items: center; /* 讓頭像、文字、收藏鈕中線對齊 */
                            gap: 16px; 
                            width: 100%; 
                            z-index: 2; 
                            margin-bottom: 20px; /* 為下方的浮動卡片留空間 */
                        }

                        .imm-avatar-box { 
                            width: 84px; height: 84px; 
                            border-radius: 50%; 
                            border: 3px solid rgba(255,255,255,0.9); 
                            background: #fff; overflow: hidden; 
                            box-shadow: 0 8px 20px rgba(0,0,0,0.15); 
                            flex-shrink: 0; 
                        }
                        .imm-avatar-img { width: 100%; height: 100%; object-fit: cover; object-position: top center; }

                        .imm-text-box { color: #fff; text-shadow: 0 2px 8px rgba(0,0,0,0.2); flex: 1; }
                        .imm-p-name { font-size: 26px; font-weight: 900; margin-bottom: 2px; }
                        .imm-p-sub { font-size: 13px; font-weight: 600; opacity: 0.9; }

                        /* 收藏按鈕 - 玻璃擬態 */
                        .pch-fav-btn {
                            width: 44px; height: 44px;
                            border-radius: 50%;
                            border: 1px solid rgba(255, 255, 255, 0.4);
                            background: rgba(255, 255, 255, 0.2);
                            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
                            display: flex; align-items: center; justify-content: center;
                            color: white; cursor: pointer; transition: all 0.3s;
                            flex-shrink: 0; padding: 0; margin-left: auto; /* 推到最右邊 */
                        }
                        .pch-fav-btn.active {
                            background: #fff;
                            color: var(--team-accent); /* 選中時變球隊色 */
                            border-color: #fff;
                            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                        }

                        /* 數據卡片 */
                        .floating-stats-card { 
                            margin: -35px 24px 0 24px; background: #fff; border-radius: 20px; 
                            display: flex; justify-content: space-between; align-items: center;
                            padding: 18px 0; box-shadow: 0 10px 25px rgba(0,0,0,0.08); 
                            border: 1px solid rgba(0,0,0,0.03); position: relative; z-index: 10;
                        }
                        .f-stat-item { flex: 1; text-align: center; }
                        .f-stat-val { font-size: 22px; font-weight: 800; color: var(--tpbl-blue); display: block; }
                        .f-stat-lbl { font-size: 11px; color: #8E8E93; font-weight: 700; }
                        .f-stat-divider { width: 1px; background: #F2F2F7; height: 20px; }
                        .imm-watermark { position: absolute; right: -20px; top: 0; height: 160px; opacity: 0.12; filter: brightness(0) invert(1); pointer-events: none; }
                /* 相關報導輪播專用 */
                .honors-scroll-wrapper {
                    display: flex; gap: 12px; overflow-x: auto;
                    padding: 4px 0 16px 0; margin: 0 -4px;
                    scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;
                }
                .honors-scroll-wrapper::-webkit-scrollbar { display: none; }
                .honor-card {
                    flex: 0 0 280px; height: 160px; scroll-snap-align: start;
                    position: relative; border-radius: 16px; overflow: hidden;
                    background: #000; box-shadow: 0 6px 15px rgba(0,0,0,0.15);
                }
                .honor-card-img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
                .honor-card-overlay {
                    position: absolute; bottom: 0; left: 0; right: 0; padding: 16px;
                    background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.4) 60%, transparent 100%);
                    display: flex; flex-direction: column; justify-content: flex-end;
                }
                    </style>
                `;

                // 2. 雷達圖
                let chartHtml = avg2 ? `<div class="section-divider"><i data-lucide="pie-chart" width="16"></i> 能力分析</div><div class="chart-card"><div class="chart-container"><canvas id="playerRadar"></canvas></div></div>` : '';

                // 3. 賽季數據趨勢
                let statsHtml = '';
                if (avg2) {
                    const getBadge = (curr, prev) => {
                        const diff = (curr - prev).toFixed(1);
                        return parseFloat(diff) > 0 ? `<span class="badge-pill bp-up">+${diff}</span>` : (parseFloat(diff) < 0 ? `<span class="badge-pill bp-down">${diff}</span>` : '-');
                    };
                    let trendRow = avg1 ? `<tr class="trend-row"><td class="season-col-fixed">趨勢</td><td></td><td>${getBadge(avg2.raw.pts, avg1.raw.pts)}</td><td>${getBadge(avg2.raw.reb, avg1.raw.reb)}</td><td>${getBadge(avg2.raw.ast, avg1.raw.ast)}</td><td>${getBadge(avg2.raw.stl, avg1.raw.stl)}</td><td>${getBadge(avg2.raw.blk, avg1.raw.blk)}</td></tr>` : '';
                    statsHtml = `<div class="section-divider"><i data-lucide="bar-chart-2" width="16"></i> 賽季數據趨勢</div><div class="season-stats-container"><div class="season-table-scroll"><table class="season-table"><thead><tr><th class="season-col-fixed">賽季</th><th>MIN</th><th>PTS</th><th>REB</th><th>AST</th><th>STL</th><th>BLK</th></tr></thead><tbody><tr class="s2-row"><td class="season-col-fixed nums">25-26</td><td>-</td><td>${avg2.pts}</td><td>${avg2.reb}</td><td>${avg2.ast}</td><td>${avg2.stl}</td><td>${avg2.blk}</td></tr>${avg1 ? `<tr class="s1-row"><td class="season-col-fixed nums">24-25</td><td>-</td><td>${avg1.pts}</td><td>${avg1.reb}</td><td>${avg1.ast}</td><td>${avg1.stl}</td><td>${avg1.blk}</td></tr>` : ''}${trendRow}</tbody></table></div></div>`;
                }

                // 4. 生涯代表作
                let bestGameHtml = '';
                const allLogs = [...s2Logs, ...s1Logs];
                const playedList = allLogs.filter(l => l.accumulated_stats?.score > 0).sort((a, b) => b.accumulated_stats.score - a.accumulated_stats.score);
                if (playedList.length > 0) {
                    const bg = playedList[0];
                    const linked = globalGames.find(x => x.id === (bg.game_id || bg.game?.id));
                    const opp = getOpponentInfo(linked, teamName);
                    bestGameHtml = `
                        <div class="section-divider"><i data-lucide="crown" width="16"></i> 生涯代表作</div>
                        <div class="best-game-small">
                            <div class="bgs-left">
                                <div class="bgs-label">SINGLE GAME HIGH</div>
                                <div class="bgs-score-row">
                                    <span class="bgs-score nums">${bg.accumulated_stats.score}</span>
                                    <span class="bgs-unit">PTS</span>
                                </div>
                                <div class="bgs-meta nums">${linked ? linked.game_date.split('-').slice(1).join('/') : '--/--'}</div>
                            </div>
                            <div class="bgs-right">
                                <div class="bgs-opp">
                                    <span>VS</span> ${opp.name}
                                    <img src="${opp.logo}">
                                </div>
                                <div class="bgs-stats-row nums">
                                    <div class="bgs-s-item"><b>${bg.accumulated_stats.rebounds}</b> REB</div>
                                    <div class="bgs-s-item"><b>${bg.accumulated_stats.assists}</b> AST</div>
                                </div>
                            </div>
                        </div>
                        <style>
                            .best-game-small { background: #1C1C1E; color: #fff; border-radius: 16px; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; background: linear-gradient(135deg, #2c2c2e 0%, #1c1c1e 100%); box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
                            .bgs-label { font-size: 9px; font-weight: 800; color: #D4B07D; letter-spacing: 1px; margin-bottom: 4px; }
                            .bgs-score { font-size: 36px; font-weight: 900; letter-spacing: -1px; line-height: 1; }
                            .bgs-unit { font-size: 12px; font-weight: 700; color: #8E8E93; margin-left: 4px; }
                            .bgs-meta { font-size: 11px; color: #8E8E93; margin-top: 2px; }
                            .bgs-opp { display: flex; align-items: center; justify-content: flex-end; gap: 8px; font-weight: 700; font-size: 14px; margin-bottom: 12px; }
                            .bgs-opp img { width: 32px; height: 32px; background: #fff; border-radius: 50%; padding: 2px; }
                            .bgs-stats-row { display: flex; gap: 12px; justify-content: flex-end; }
                            .bgs-s-item { font-size: 11px; color: #8E8E93; }
                            .bgs-s-item b { color: #fff; font-size: 13px; margin-right: 2px; }
                        </style>
                    `;
                }

                // 5. 近期表現
                let recentHtml = '';
                const recentLogs = allLogs.sort((a, b) => new Date(b.game?.gamed_at || 0) - new Date(a.game?.gamed_at || 0)).slice(0, 5);
                if (recentLogs.length > 0) {
                    let rows = recentLogs.map(g => {
                        const linked = globalGames.find(x => x.id === (g.game_id || g.game?.id));
                        const opp = getOpponentInfo(linked, teamName);
                        return `<tr><td><div class="rg-date nums">${linked ? linked.game_date.split('-').slice(1).join('/') : '-'}</div><div class="rg-opp"><img src="${opp.logo}" width="16"> ${opp.name}</div></td><td class="nums highlight-col">${g.accumulated_stats.score}</td><td>${g.accumulated_stats.rebounds}</td><td>${g.accumulated_stats.assists}</td></tr>`;
                    }).join('');
                    recentHtml = `<div class="section-divider"><i data-lucide="history" width="16"></i> 近期表現</div><table class="recent-games-table"><thead><tr><th>日期 / 對手</th><th>得分</th><th>籃板</th><th>助攻</th></tr></thead><tbody>${rows}</tbody></table>`;
                }

                // 6. 獎項
                let awardsHtml = '';
                const myAwards = globalAwards.filter(a => a.winner?.some(w => w.info.name === pBasic?.name));
                if (myAwards.length > 0) {
                    const annual = myAwards.filter(a => a.type === 'annual');
                    const monthly = myAwards.filter(a => a.type === 'monthly');
                    awardsHtml = `<div class="awards-container">` +
                        (annual.length ? `<div class="awards-section-title">年度榮譽</div><div class="annual-awards-grid">` + annual.map(a => `<div class="aa-card"><div class="aa-icon"><i data-lucide="${getAwardIcon(a.title)}" width="20"></i></div><div class="aa-title">${a.title}</div><div class="aa-season nums">${a.season.name}</div></div>`).join('') + `</div>` : '') +
                        (monthly.length ? `<div class="awards-section-title">單月最佳</div><div class="monthly-scroll">` + monthly.map(a => `<div class="ma-card"><div class="ma-header"><i data-lucide="trophy" width="12"></i> MVP</div><div class="ma-title">${a.en_title.split('(')[1]?.replace(')', '') || 'MVP'}</div><div class="nums" style="font-size:9px; color:#aaa">${a.season.name}</div></div>`).join('') + `</div>` : '') +
                    `</div>`;
                }

                // --- 在 openPlayerProfile 函數內部 ---

                // --- 新增：抓取所有包含球員姓名的報導 ---
                                const searchName = pBasic.name.replace(/\s/g, ''); // 沃許本
                                const myNews = (globalAllNews || []).filter(post => post.title.includes(searchName));

                                let newsHtml = "";
                                if (myNews.length > 0) {
                                    newsHtml = `
                                        <div class="section-divider"><i data-lucide="newspaper" width="16"></i> 相關報導 (${myNews.length})</div>
                                        <div class="honors-scroll-wrapper">
                                            ${myNews.map(post => {
                                                // 判斷是否為大獎
                                                const isAward = post.title.includes('年度') || post.title.includes('MVP') || post.title.includes('🏆');
                                                const tag = isAward ? '🏆 AWARD' : 'NEWS';
                                                const tagColor = isAward ? 'var(--tpbl-gold)' : 'rgba(255,255,255,0.3)';
                                                return `
                                                <div class="honor-card" onclick="window.open('https://tpbl.basketball/news/${post.id}', '_blank')">
                                                    <img src="${post.thumbnail}" class="honor-card-img" loading="lazy">
                                                    <div class="honor-card-overlay">
                                                        <div class="hpc-badge" style="background:${tagColor}; color:${isAward ? 'var(--tpbl-blue)' : '#fff'}; font-size:9px; font-weight:800; padding:2px 6px; border-radius:4px; align-self:flex-start; margin-bottom:6px;">${tag}</div>
                                                        <div class="hpc-title" style="color:#fff; font-size:14px; font-weight:700; line-height:1.3; margin-bottom:4px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">${post.title}</div>
                                                        <div class="hpc-date nums" style="color:rgba(255,255,255,0.5); font-size:10px;">${post.published_at.split(' ')[0]}</div>
                                                    </div>
                                                </div>`;
                                            }).join('')}
                                        </div>`;
                                }

                                // --- 修改這行：將 ${newsHtml} 插入到 ${statsHtml} 之後 ---
                                body.innerHTML = `${headerHtml}${chartHtml}${statsHtml}${newsHtml}${bestGameHtml}${recentHtml}${awardsHtml}<div style="height:40px;"></div>`;
                                lucide.createIcons();

                // 繪製雷達圖
                if (avg2 && document.getElementById('playerRadar')) {
                    const ctx = document.getElementById('playerRadar').getContext('2d');
                    new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: ['得分', '籃板', '助攻', '抄截', '阻攻'],
                            datasets: [{
                                data: [Math.min(100,(avg2.raw.pts/20)*100), Math.min(100,(avg2.raw.reb/10)*100), Math.min(100,(avg2.raw.ast/8)*100), Math.min(100,(avg2.raw.stl/3)*100), Math.min(100,(avg2.raw.blk/2)*100)],
                                backgroundColor: hexToRgba(teamColor, 0.4), borderColor: teamColor, borderWidth: 2, pointRadius: 0
                            }]
                        },
                        options: { scales: { r: { suggestMin: 0, suggestMax: 100, ticks: { display: false } } }, plugins: { legend: { display: false } } }
                    });
                }
            } catch (e) {
                console.error(e);
                body.innerHTML = `<div class="loading">加載數據失敗，請稍後再試</div>`;
            }
        }
        function renderPeriodTable(data, hName, aName) { if (!data.home_team.periods) return ''; const hPeriods = data.home_team.periods; const aPeriods = data.away_team.periods; let headerCols = ''; let aCols = ''; let hCols = ''; for(let i=0; i<Math.max(hPeriods.length, aPeriods.length); i++) { let label = (i < 4) ? `Q${i+1}` : `OT${i-3}`; headerCols += `<th>${label}</th>`; aCols += `<td>${(aPeriods[i] && aPeriods[i].score !== undefined) ? aPeriods[i].score : '-'}</td>`; hCols += `<td>${(hPeriods[i] && hPeriods[i].score !== undefined) ? hPeriods[i].score : '-'}</td>`; } return `<div style="border-top:1px dashed #eee; margin-top:10px; padding-top:10px;"><div class="period-scroll"><table class="period-table"><thead><tr><th style="text-align:left"></th>${headerCols}</tr></thead><tbody><tr class="pt-row"><td class="period-team-name">${aName}</td>${aCols}</tr><tr class="pt-row"><td class="period-team-name">${hName}</td>${hCols}</tr></tbody></table></div></div>`; }
        function renderGameFlowTable(homeRounds, awayRounds, hName, aName) { let headerHtml = '<th>球隊</th>'; let hRow = `<td class="flow-team-name">${hName}</td>`; let aRow = `<td class="flow-team-name">${aName}</td>`; for(let i=1; i<=10; i++) { if(homeRounds[i] && awayRounds[i]) { let label = (i <= 4) ? `Q${i}` : `OT${i-4}`; headerHtml += `<th>${label}</th>`; hRow += `<td>${homeRounds[i].won_score}</td>`; aRow += `<td>${awayRounds[i].won_score}</td>`; } else break; } return `<div class="comparison-card"><div class="comp-title"><i data-lucide="list-ordered" width="14"></i> 分節得分</div><div class="period-scroll"><table class="flow-table"><thead><tr>${headerHtml}</tr></thead><tbody><tr>${aRow}</tr><tr>${hRow}</tr></tbody></table></div></div>`; }
        function renderTeamComparison(homeStats, awayStats) { const metrics = [ { key: 'field_goals_percentage', label: '投籃 %', isPct: true }, { key: 'three_pointers_percentage', label: '三分 %', isPct: true }, { key: 'free_throws_percentage', label: '罰球 %', isPct: true }, { key: 'rebounds', label: '籃板', isPct: false }, { key: 'assists', label: '助攻', isPct: false }, { key: 'steals', label: '抄截', isPct: false }, { key: 'turnovers', label: '失誤', isPct: false, invert: true } ]; let rowsHtml = ''; metrics.forEach(m => { let valH = parseFloat(homeStats[m.key]) || 0; let valA = parseFloat(awayStats[m.key]) || 0; let maxVal = Math.max(valH, valA); if(m.isPct) maxVal = 100; let perH = (maxVal > 0) ? (valH / maxVal * 100) : 0; let perA = (maxVal > 0) ? (valA / maxVal * 100) : 0; let isLeftWin = m.invert ? (valA < valH) : (valA > valH); let isRightWin = m.invert ? (valH < valA) : (valH > valA); rowsHtml += `<div class="comp-row"><div class="comp-side left"><div class="comp-wrapper"><div class="comp-val nums">${m.isPct?valA+'%':valA}</div><div class="comp-bar-bg"><div class="comp-bar left ${isLeftWin ? 'winner' : ''}" style="width: ${perA}%"></div></div></div></div><div class="comp-label">${m.label}</div><div class="comp-side right"><div class="comp-wrapper"><div class="comp-bar-bg"><div class="comp-bar right ${isRightWin ? 'winner' : ''}" style="width: ${perH}%"></div></div><div class="comp-val nums">${m.isPct?valH+'%':valH}</div></div></div></div>`; }); return `<div class="comparison-card"><div class="comp-title"><i data-lucide="arrow-left-right" width="14"></i> 球隊數據對比</div>${rowsHtml}</div>`; }
//Best Player in the game
function renderGameBestPlayers(data) {
    try {
        const getTopScorer = (teamNode) => {
            const players = Array.isArray(teamNode.players.total) ? teamNode.players.total :
                           (Array.isArray(teamNode.players) ? teamNode.players : Object.values(teamNode.players.total || teamNode.players || {}));
            
            return players
                .filter(p => p && p.time_on_court > 0)
                .sort((a, b) => (b.score || 0) - (a.score || 0))[0];
        };

        const aBest = getTopScorer(data.away_team);
        const hBest = getTopScorer(data.home_team);

        if (!hBest && !aBest) return '';

        const renderPlayerRow = (player, teamName) => {
            if (!player) return '';
            const headUrl = playerMap[player.name.replace(/\s/g, '')] || DEFAULT_AVATAR;
            const teamColor = getTeamColor(teamName);
            return `
                <div class="leader-row" onclick="openPlayerProfile(${player.id})">
                    <div class="lr-player">
                        <img src="${headUrl}" class="lr-img" style="${!playerMap[player.name.replace(/\s/g, '')] ? `background:${teamColor}` : ''}">
                        <div class="lr-info">
                            <div class="lr-name">${player.name}</div>
                            <div class="lr-team">${getShortName(teamName)} · #${player.number || ''}</div>
                        </div>
                    </div>
                    <div class="lr-stats-group">
                        <div class="lr-stat-item">
                            <div class="lr-val nums">${player.score || 0}</div>
                            <div class="lr-label">得分</div>
                        </div>
                        <div class="lr-stat-item">
                            <div class="lr-val nums">${player.rebounds || 0}</div>
                            <div class="lr-label">籃板</div>
                        </div>
                        <div class="lr-stat-item">
                            <div class="lr-val nums">${player.assists || 0}</div>
                            <div class="lr-label">助攻</div>
                        </div>
                    </div>
                </div>`;
        };

        return `
            <div class="game-leaders">
                <div class="leaders-title"><i data-lucide="award" width="14"></i> 本場最佳表現</div>
                <div class="leaders-vertical">
                    ${renderPlayerRow(aBest, data.away_team.name)}
                    <!-- 這裡刪除了原本的實線 div -->
                    ${renderPlayerRow(hBest, data.home_team.name)}
                </div>
            </div>`;
    } catch (e) {
        console.error("Render Best Players Error:", e);
        return '';
    }
}
  function renderTeamBoxScore(playersNode, teamName, teamTotalNode) {
    const players = Array.isArray(playersNode) ? playersNode : Object.values(playersNode || {});
    if(players.length === 0) return `<div style="padding:40px; text-align:center;">暫無數據</div>`;
    
    const fmtPct = (val) => (val !== undefined && val !== null) ? val + '%' : '0.0%';
    const tableHeader = (label) => `<tr><th>${label}</th><th>PTS</th><th>REB</th><th>AST</th><th>STL</th><th>BLK</th><th>FG</th><th>FG%</th><th>3PT</th><th>3P%</th><th>FT</th><th>FT%</th><th>MIN</th></tr>`;

    let html = `<div class="boxscore-section">
        <div class="boxscore-title"><img src="${getLogo(teamName)}" width="20"> ${getShortName(teamName)}</div>
        <div class="bs-scroll">
            <table class="bs-table">
                <thead>${tableHeader('球員')}</thead>
                <tbody>`;
    
    // 排序：先發 true 在前，再按上場時間排
    players.sort((a, b) => (b.is_starting === a.is_starting) ? (b.time_on_court - a.time_on_court) : (b.is_starting ? 1 : -1));

    let benchStarted = false;
    players.forEach((p) => {
        // 區隔先發與替補
        if (!p.is_starting && !benchStarted) {
            html += `<tr class="separator-row"><td class="sticky-sep">替補</td><td colspan="12" class="filler-sep"></td></tr>`;
            benchStarted = true;
        }

        const isDnp = !p.time_on_court || p.time_on_court === 0;
        const headUrl = playerMap[p.name.replace(/\s/g, '')];
        const mins = isDnp ? 'DNP' : `${Math.floor(p.time_on_court/60)}:${(p.time_on_court%60).toString().padStart(2,'0')}`;

        html += `<tr class="${isDnp ? 'dnp-row' : ''}" onclick="openPlayerProfile(${p.id})">
            <td><div class="player-head-cell"><img src="${headUrl || DEFAULT_AVATAR}" class="player-headshot" style="${!headUrl ? `background:${getTeamColor(teamName)}` : ''}"> ${p.name}</div></td>
            <td class="nums" style="font-weight:800; color:var(--tpbl-blue)">${p.score ?? 0}</td>
            <td class="nums">${p.rebounds ?? 0}</td>
            <td class="nums">${p.assists ?? 0}</td>
            <td class="nums">${p.steals ?? 0}</td>
            <td class="nums">${p.blocks ?? 0}</td>
            <td class="nums">${p.field_goals || '0/0'}</td>
            <td class="nums" style="color:#8E8E93">${fmtPct(p.field_goals_percentage)}</td>
            <td class="nums">${p.three_pointers || '0/0'}</td>
            <td class="nums" style="color:#8E8E93">${fmtPct(p.three_pointers_percentage)}</td>
            <td class="nums">${p.free_throws || '0/0'}</td>
            <td class="nums" style="color:#8E8E93">${fmtPct(p.free_throws_percentage)}</td>
            <td class="nums" style="color:#888">${mins}</td>
        </tr>`;
    });
    
    if (teamTotalNode) {
        const tt = teamTotalNode;
        // 總計列上方重複表頭
        html += `<tr class="bs-table-subheader">${tableHeader('項目').replace('<tr>', '').replace('</tr>', '')}</tr>`;
        
        // 團隊總計 (修正 PTS 取值)
        html += `<tr class="total-row-highlight">
            <td class="sticky-sep">團隊總計</td>
            <td class="nums">${tt.won_score ?? tt.score ?? 0}</td>
            <td class="nums">${tt.rebounds ?? 0}</td>
            <td class="nums">${tt.assists ?? 0}</td>
            <td class="nums">${tt.steals ?? 0}</td>
            <td class="nums">${tt.blocks ?? 0}</td>
            <td class="nums">${tt.field_goals ?? '0/0'}</td>
            <td class="nums">${fmtPct(tt.field_goals_percentage)}</td>
            <td class="nums">${tt.three_pointers ?? '0/0'}</td>
            <td class="nums">${fmtPct(tt.three_pointers_percentage)}</td>
            <td class="nums">${tt.free_throws ?? '0/0'}</td>
            <td class="nums">${fmtPct(tt.free_throws_percentage)}</td>
            <td>-</td>
        </tr>`;
    }

    return html + `</tbody></table></div></div>`;
}


        window.switchMainTab = function(tab) {
            document.querySelectorAll('.tab-bar .tab-btn').forEach(b => b.classList.remove('active'));
            // 根據標籤順序設定 active
            const btnMap = { 'home': 0, 'teams': 1, 'stats': 2, 'schedule': 3 };
            document.querySelectorAll('.tab-bar .tab-btn')[btnMap[tab]].classList.add('active');

            if(tab === 'home') renderHome();
            else if (tab === 'teams') renderTeams();
            else if (tab === 'stats') renderStats(); // 呼叫新函數
            else renderSchedule();
        };
        let statsMode = 'players';

        function renderStats() {
            const container = document.getElementById('app-container');
            container.innerHTML = '';
            const wrapper = document.createElement('div');
            wrapper.className = 'container';

            // 1. 頂部切換
            wrapper.innerHTML = `
                <div class="section-header" style="margin-top:0"><div class="section-title">數據排行榜</div></div>
                <div class="seg-control" style="margin-bottom:24px;">
                    <button class="seg-btn ${statsMode === 'players' ? 'active' : ''}" onclick="toggleStatsPage('players')">個人排名</button>
                    <button class="seg-btn ${statsMode === 'teams' ? 'active' : ''}" onclick="toggleStatsPage('teams')">團隊排名</button>
                </div>
            `;

            if (statsMode === 'players' && globalTopPlayers) {
                // 定義個人數據類別 (補齊抄截與阻攻)
                const pCats = [
                    { key: 'score_per_match', label: '場均得分', icon: 'zap' },
                    { key: 'rebounds_per_match', label: '場均籃板', icon: 'circle' },
                    { key: 'assists_per_match', label: '場均助攻', icon: 'send' },
                    { key: 'steals_per_match', label: '場均抄截', icon: 'hand' },
                    { key: 'blocks_per_match', label: '場均阻攻', icon: 'shield' }
                ];

                pCats.forEach(cat => {
                    const list = globalTopPlayers[cat.key] || [];
                    if (list.length === 0) return;

                    wrapper.innerHTML += `<div class="section-title"><i data-lucide="${cat.icon}" width="18"></i> ${cat.label}</div>`;
                    const card = document.createElement('div');
                    card.className = 'stats-list-card';

                    list.slice(0, 5).forEach((item, idx) => {
                        const p = item.player;
                        const avatar = p.images?.find(i => i.key === 'sm')?.url || p.images?.[0]?.url || DEFAULT_AVATAR;
                        card.innerHTML += `
                            <div class="rank-row" onclick="openPlayerProfile(${p.id})">
                                <div class="rank-index">${idx + 1}</div>
                                <img src="${avatar}" class="rank-photo">
                                <div class="rank-main-info">
                                    <div class="rank-name-txt">${p.name}</div>
                                    <div class="rank-meta-txt"><img src="${getLogo(p.team.name)}" class="rank-logo-sm"> ${getShortName(p.team.name)} · #${p.number}</div>
                                </div>
                                <div class="rank-val-txt nums">${item.value.toFixed(1)}</div>
                            </div>`;
                    });
                    wrapper.appendChild(card);
                });
            } else if (statsMode === 'teams' && globalTopTeams) {
                // 定義團隊數據類別 (移除長條圖，改用列表)
                const tCats = [
                    { key: 'won_score_per_match', label: '團隊場均得分', icon: 'target' },
                    { key: 'three_pointers_percentage', label: '三分命中率', icon: 'percent', isPct: true },
                    { key: 'assists_per_match', label: '團隊場均助攻', icon: 'send' },
                    { key: 'rebounds_per_match', label: '團隊場均籃板', icon: 'circle' }
                ];

                tCats.forEach(cat => {
                    const list = globalTopTeams[cat.key] || [];
                    if (list.length === 0) return;

                    wrapper.innerHTML += `<div class="section-title"><i data-lucide="${cat.icon}" width="18"></i> ${cat.label}</div>`;
                    const card = document.createElement('div');
                    card.className = 'stats-list-card';

                    list.slice(0, 5).forEach((item, idx) => {
                        const t = item.team;
                        const val = cat.isPct ? (item.value * 100).toFixed(1) + '%' : item.value.toFixed(1);
                        card.innerHTML += `
                            <div class="rank-row" onclick="selectTeam('${getShortName(t.name)}'); switchMainTab('teams');">
                                <div class="rank-index">${idx + 1}</div>
                                <img src="${getLogo(t.name)}" class="rank-photo" style="object-fit:contain; padding:4px;">
                                <div class="rank-main-info">
                                    <div class="rank-name-txt">${t.name}</div>
                                    <div class="rank-meta-txt">${getShortName(t.name)}</div>
                                </div>
                                <div class="rank-val-txt nums">${val}</div>
                            </div>`;
                    });
                    wrapper.appendChild(card);
                });
            }

            container.appendChild(wrapper);
            lucide.createIcons();
        }

        window.toggleStatsPage = function(mode) {
            statsMode = mode;
            renderStats();
        };

        // 更新 switchMainTab，加入 stats 判斷
        const oldSwitchMainTab = window.switchMainTab;
        window.switchMainTab = function(tab) {
            document.querySelectorAll('.tab-bar .tab-btn').forEach(b => b.classList.remove('active'));
            const btnMap = { 'home': 0, 'teams': 1, 'stats': 2, 'schedule': 3 };
            if (btnMap[tab] !== undefined) document.querySelectorAll('.tab-bar .tab-btn')[btnMap[tab]].classList.add('active');

            if (tab === 'stats') renderStats();
            else if (tab === 'home') renderHome();
            else if (tab === 'teams') renderTeams();
            else renderSchedule();
        };
        //以上新增團隊數據
        window.switchScheduleTab = function(tab) { currentScheduleTab = tab; renderSchedule(); };
        window.switchModalTab = function(tab) { document.querySelectorAll('.modal-tab-btn').forEach(b => b.classList.remove('active')); document.querySelector(`.modal-tab-btn[onclick*="${tab}"]`).classList.add('active'); document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden')); document.getElementById(`tab-${tab}`).classList.remove('hidden'); }

        init();
    </script>
</body>
</html>

